---
title: "Example with linguistic data"
output:
  html_document:
    code_folding: hide
---

Data is based on [this paper](https://arxiv.org/pdf/1308.5499.pdf). Also see [tutorial here](https://web.stanford.edu/class/psych252/section/Mixed_models_tutorial.html).

```{r setup, include = FALSE}
library(lme4)
library(tidyverse)
library(ggbeeswarm)
library(colorspace)
library(dplyr)
library(nullabor)
library(MASS)

knitr::opts_chunk$set(message = FALSE,warning = FALSE#,
  #cache.path = "cache/",
  #cache = TRUE
  )
df <- read_csv(here::here("data/politeness_data.csv")) %>%
  mutate(
    scenario = fct_reorder(factor(scenario), frequency, function(x) {
      mean(x, na.rm = TRUE)
    }),
    subject = fct_reorder(subject, frequency, function(x) {
      mean(x, na.rm = TRUE)
    })
  )
```

The data contains `r nrow(df)` observations on the voice pitch (or frequency) from `r length(unique(df$subject))` subjects (3 females and 3 males) under `r length(unique(df$scenario))` scenarios with 2 attitudes (informal or polite). There is one missing value for subject `M4` for scenario 6 with polite attitude.

We fixed the missing value by the mean value of the male with scenario 6 and polite attitude.

```{r}
df[39, ]$frequency <- round((df %>% filter(
  gender == "M",
  scenario == 6,
  attitude == "pol"
) %>%
  summarise(mean(frequency, na.rm = T))), 1) %>% 
  as.numeric()

df <- df[order(df$subject), ]
```



```{r eda-plots}
ggplot(df, aes(subject, frequency, fill = gender)) +
  geom_boxplot(width = 0.5) +
  geom_beeswarm(color = "#383838") +
  scale_fill_discrete_qualitative()

ggplot(df, aes(attitude, frequency, fill = gender)) +
  geom_boxplot(width = 0.5) +
  geom_beeswarm(color = "#383838") +
  facet_grid(. ~ subject) +
  scale_fill_discrete_qualitative()

ggplot(df, aes(gender, frequency)) +
  geom_boxplot(width = 0.5) +
  geom_beeswarm(color = "#383838") +
  facet_grid(. ~ attitude) +
  scale_fill_discrete_qualitative()

ggplot(df, aes(scenario, frequency)) +
  geom_boxplot() +
  geom_beeswarm(aes(color = gender)) +
  scale_color_discrete_qualitative()
```

We fit the following model:

$$\begin{array}\texttt{frequency}_{i} &=& \beta_0 + \beta_1\mathbb{I}(\texttt{attitude}_{i}=\texttt{pol}) + \beta_2 \mathbb{I}(\texttt{gender}_{i}=\texttt{M}) +\\ && u_1\mathbb{I}(\texttt{subject}_i=\texttt{F1})+ u_2\mathbb{I}(\texttt{subject}_i=\texttt{F2}) + u_3\mathbb{I}(\texttt{subject}_i=\texttt{F3}) + u_4\mathbb{I}(\texttt{subject}_i=\texttt{M1})+ u_5\mathbb{I}(\texttt{subject}_i=\texttt{M2})+ u_6\mathbb{I}(\texttt{subject}_i=\texttt{M3}) + \\ && u_7\mathbb{I}(\texttt{scenario}_i=\texttt{1}) + u_8\mathbb{I}(\texttt{scenario}_i=\texttt{2}) + u_9\mathbb{I}(\texttt{scenario}_i=\texttt{3}) + u_{10}\mathbb{I}(\texttt{scenario}_i=\texttt{4}) + u_{11}\mathbb{I}(\texttt{scenario}_i=\texttt{5}) + u_{12}\mathbb{I}(\texttt{scenario}_i=\texttt{6}) +\\&& u_{13}\mathbb{I}(\texttt{scenario}_i=\texttt{7}) + e_i\end{array}$$
assuming that $\boldsymbol{u} = (u_1, ..., u_{13})^\top \sim N(\boldsymbol{0}, \mathbf{G})$ and $\boldsymbol{e} = (e_1, ..., e_{84})^\top = \sim N(\boldsymbol{0}, \sigma^2\mathbf{I}_{84})$, where $\mathbf{G}=\begin{bmatrix}\sigma^2_{\texttt{subject}}\mathbf{I}_6 & \mathbf{0}_{6\times 7}\\ \mathbf{0}_{7\times 6} & \sigma^2_{\texttt{scenario}}\mathbf{I}_7\end{bmatrix}.$

```{r fitfn}
lin_extract_fitted_mod <- function(mod, data) {
  N <- nrow(data)
  subjects <- unique(data$subject)
  nsubject <- length(subjects)
  scenarios <- unique(data$scenario)
  nscenario <- length(scenarios)

  y <- data$y
  X <- model.matrix(~ attitude + gender, data = data)
  beta <- fixef(mod)
  Z1 <- model.matrix(~ scenario - 1, data = data)
  Z2 <- model.matrix(~ subject - 1, data = data)
  Z <- cbind(Z1, Z2)
  u <- c(ranef(mod)$scenario[, 1], ranef(mod)$subject[, 1])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == "Residual"] * diag(N)
  G1 <- vc$vcov[vc$grp == "scenario"] * diag(nscenario)
  G2 <- vc$vcov[vc$grp == "subject"] * diag(nsubject)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted_df <- data %>%
    dplyr::mutate(
      fitted = as.vector(X %*% beta),
      resm = y - fitted,
      resc = y - fitted - as.vector(Z %*% u),
      index = 1:n()
    ) %>%
    mutate(
      resm_std = resm / sqrt(diag(varMargRes)[index]),
      resc_std = resc / sqrt(diag(varCondRes)[index])
    ) %>%
    ungroup()

  return(fitted_df)
}
```

```{r unitfn}
lin_extract_unit_mod <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$subject)
  nsubject <- length(subjects)
  scenarios <- unique(data$scenario)
  nscenario <- length(scenarios)

  y <- data$y
  X <- model.matrix(~attitude + gender, data = data)
  beta <- fixef(mod)
  Z1 <- model.matrix(~scenario - 1, data = data)
  Z2 <- model.matrix(~subject - 1, data = data)
  Z <- cbind(Z1, Z2)  
  u <- c(ranef(mod)$scenario[,1], ranef(mod)$subject[,1])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp=="scenario"] * diag(nscenario)
  G2 <- vc$vcov[vc$grp=="subject"] * diag(nsubject)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  fitted <-  as.vector(X %*% beta)
  resm <-  y - fitted
  resc <-  y - fitted - as.vector(Z %*% u)
  
  unit_df <- expand_grid(subjects, scenarios) %>% 
    dplyr::mutate(Vi = map2_dbl(subjects, scenarios, ~{
                        ind <- data %>% 
                          dplyr::mutate(index = 1:n()) %>% 
                          filter(subject==.x,
                                 scenario==.y) %>% 
                          pull(index)
                         mi <- length(ind)
                        # standardised marginal residual
                        Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
                        v1 <- (diag(mi)- Ei %*% t(Ei))
                        sqrt(sum(diag(v1 %*% t(v1)))) / mi
                      }),
         Mi = as.vector(t(u) %*% solve(varU) %*% u),
         index = 1:n()
         )
  
  return(unit_df)
}
```

```{r}
lin_extract_lcr_mod <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$subject)
  nsubject <- length(subjects)
  scenarios <- unique(data$scenario)
  nscenario <- length(scenarios)

  y <- data$y
  X <- model.matrix(~attitude + gender, data = data)
  beta <- fixef(mod)
  Z1 <- model.matrix(~scenario - 1, data = data)
  Z2 <- model.matrix(~subject - 1, data = data)
  Z <- cbind(Z1, Z2)  
  u <- c(ranef(mod)$scenario[,1], ranef(mod)$subject[,1])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp=="scenario"] * diag(nscenario)
  G2 <- vc$vcov[vc$grp=="subject"] * diag(nsubject)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted <-  as.vector(X %*% beta)
  resm <-  y - fitted
  resc <-  y - fitted - as.vector(Z %*% u)
  index <- 1:nrow(data)
  resm_std <-  resm/sqrt(diag(varMargRes)[index])
  resc_std = resc/sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var_resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  reslc_lin <- (lt %*% resc[1:N] )/sqrt(diag(var_resmcp))

  reslc_lin <- tibble::tibble(reslc_lin)
  
  return(reslc_lin)
}
```

```{r simulatefn}
lin_sim <- function(mod, data, nsim = 19, seed, std = FALSE){
  fit_sim <- simulate(mod, nsim = nsim, seed = seed)
  fit_refit <- lapply(fit_sim, refit, object = mod)
  fit_simy <- lapply(fit_refit, function(x) getME(x, 'y'))
  fit_simy_y <- do.call("cbind", fit_simy)
  fit_simy_y <- reshape2::melt(fit_simy_y)[-1]
  names(fit_simy_y) <- c(".n", "y")
  fit_simy_y$.n <- as.numeric(str_extract(fit_simy_y$.n, "\\d+"))
  fit_simy_y$attitude <- rep(data$attitude, 19)
  fit_simy_y$gender <- rep(data$gender, 19)
  fit_simy_y$subject <- rep(data$subject, 19)
  fit_simy_y$scenario <- rep(data$scenario, 19)
  return(fit_simy_y)
}
```


```{r model}
colnames(df)[5] <- c("y")
#df <- na.omit(df)
fit <- lmer(y ~ attitude + gender + 
              (1|subject) + (1|scenario),
            data = df)

lin_fitted <- lin_extract_fitted_mod(fit, df)
lin_unit <- lin_extract_unit_mod(fit, df)
lin_lcr <- lin_extract_lcr_mod(fit, df)
```


```{r}
std_res <- function(data) {
  purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ 1 +attitude + gender + 
              (1|subject) + (1|scenario),
            data = df)
  
  N <- nrow(df)
  subjects <- unique(df$subject)
  nsubject <- length(subjects)
  scenarios <- unique(df$scenario)
  nscenario <- length(scenarios)

  y <- df$y
  X <- model.matrix(~attitude + gender, data = df)
  beta <- fixef(m)
  Z1 <- model.matrix(~scenario - 1, data = df)
  Z2 <- model.matrix(~subject - 1, data = df)
  Z <- cbind(Z1, Z2)
  u <- c(ranef(m)$scenario[,1], ranef(m)$subject[,1])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp=="scenario"] * diag(nscenario)
  G2 <- vc$vcov[vc$grp=="subject"] * diag(nsubject)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
}
```


```{r}
lcr_res <- function(data) {
  
  purrr::map_dfr(1:19, function(i){
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ 1 +attitude + gender + 
              (1|subject) + (1|scenario),
            data = df)
  
  N <- nrow(df)
  subjects <- unique(df$subject)
  nsubject <- length(subjects)
  scenarios <- unique(df$scenario)
  nscenario <- length(scenarios)

  y <- df$y
  X <- model.matrix(~attitude + gender, data = df)
  beta <- fixef(m)
  Z1 <- model.matrix(~scenario - 1, data = df)
  Z2 <- model.matrix(~subject - 1, data = df)
  Z <- cbind(Z1, Z2)
  u <- c(ranef(m)$scenario[,1], ranef(m)$subject[,1])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp=="scenario"] * diag(nscenario)
  G2 <- vc$vcov[vc$grp=="subject"] * diag(nsubject)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  reslc_lin <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  
  .n = i

  tibble::tibble(.n, reslc_lin)
})
}
```


## Diagnostic Plot 1: Linearity of fixed effects

By using the marginal residual versus explanatory variables is better than versus fitted value.

```{r plot1}
ggplot(lin_fitted, aes(fitted, resm_std)) + 
  geom_hline(yintercept = 0) +
  geom_point()

ggplot(lin_fitted, aes(interaction(attitude, gender), resm_std)) + 
  geom_boxplot() 
```

# Diagnostic Plot 2: Prescence of outlying observations

```{r plot2}
ggplot(lin_fitted, aes(index, resm_std, 
                   color = subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) + 
  scale_color_discrete_qualitative()

lin_fitted %>% 
  arrange(scenario) %>% 
  dplyr::mutate(index = 1:n()) %>% 
  ggplot(aes(index, resm_std, color = scenario)) + 
  geom_point() + 
  geom_hline(yintercept = 0) + 
  scale_color_discrete_qualitative()
```

# Diagnostic Plot 3: Within-units covariance matrix

I think this works better when there is a more complex covariance structure so perhaps omit from using this. 

```{r plot3}
# Dashed line: third quartile + 1.5 interquartile range
LSlesverb <- as.numeric(quantile(lin_unit$Vi,prob = 0.75, na.rm = T) + 1.5*(quantile(lin_unit$Vi, prob = 0.75, na.rm = T) - quantile(lin_unit$Vi,prob = 0.25, na.rm = T)))

ggplot(lin_unit, aes(index, Vi)) + 
  geom_point() + 
  geom_hline(yintercept = LSlesverb, lty = 2) +
  geom_text(
    data = lin_unit %>% 
      filter(Vi>LSlesverb),
    aes(label = index),
    nudge_x = 0.35, nudge_y = 0.35,
    size = 2
  )
```


# Diagnostic Plot 4: Prescense of outlying observations using conditional residual

```{r plot4}
ggplot(lin_fitted, aes(index, resc_std, 
                   color = subject)) + 
  geom_point() + 
  geom_hline(yintercept = 3, lty = 2) + 
  scale_color_discrete_qualitative() + 
  geom_text(
    data = lin_fitted %>% 
      filter(resc_std>3),
    aes(label = index),
    nudge_x = 0.35, nudge_y = 0.35,
    size = 2
  )

lin_fitted %>% 
  arrange(scenario) %>% 
  dplyr::mutate(index = 1:n()) %>% 
  ggplot(aes(index, resc_std, color = scenario)) + 
  geom_point() + 
  geom_hline(yintercept = 3, lty = 2) + 
  scale_color_discrete_qualitative()
```


# Diagnostic Plot 5: Homoskedasticity of conditional errors 

```{r plot5}
ggplot(lin_fitted, aes(fitted, resc_std)) + 
  geom_hline(yintercept = 0) +
  geom_point()
```

# Diagnostic Plot 6: Normality of conditional errors

$c^\top_k \hat e^*$

## Standardised conditional residual

```{r plot6}
ggplot(lin_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")
```
## Least confounded residual

```{r}
ggplot(lin_lcr, aes(sample = reslc_lin)) + 
  geom_qq() + geom_qq_line(color = "red")
```

- The least confounded conditional residual seems not follow a normal distribution

# Diagnostic Plot 7: Presencse of outlying subjects 

```{r plot7}
ggplot(lin_unit, aes(interaction(subjects, scenarios), Mi)) + 
  geom_point()
```

# Diagnostic Plot 8: Normality of the random effects

```{r plot8}
u <- c(ranef(fit)$scenario[,1], ranef(fit)$subject[,1])
q <- length(u)
ggplot(lin_unit, aes(sample = Mi)) + 
  geom_qq(distribution = stats::qchisq,
          dparams = list(df = q)) +
  geom_qq_line(color = "red",
               distribution = stats::qchisq,
               dparams = list(df = q))
```

## *Version 1 - "best" model

```{r v1data}
set.seed(3526)

N <- nrow(df)
nscenario <- length(unique(df$scenario))
nsubject <- length(unique(df$subject))

vc <- as.data.frame(VarCorr(fit))

R <- vc$vcov[vc$grp == "Residual"] * diag(N)
G1 <- vc$vcov[vc$grp=="scenario"] * diag(nscenario)
G2 <- vc$vcov[vc$grp=="subject"] * diag(nsubject)
G <- Matrix::bdiag(G1, G2)

n <- getME(fit, "n")
q <- getME(fit, "q")

# normal error
e <- mvrnorm(n = 1, mu = rep(0,n), Sigma = R)

# normal random effects
b <- mvrnorm(n = 1, mu = rep(0,q), Sigma = G)

y <- as.vector(getME(fit, "X") %*% fixef(fit) + getME(fit, "Z") %*% b + e)

v1_lin <- tibble(df[,-5], y)
```

```{r v1mod}
v1_lin_mod <- lmer(y ~ attitude + gender + 
              (1|subject) + (1|scenario),
            data = v1_lin)
```

```{r v1-extract}
v1_lin_fitted <- lin_extract_fitted_mod(v1_lin_mod, v1_lin)
v1_lin_lcr <- lin_extract_lcr_mod(v1_lin_mod, v1_lin)
```

# Data plots

```{r v1-plots}
ggplot(v1_lin_fitted, aes(index, 
                          resm_std, 
                          color = subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  xlab(NULL) + 
  ylab(NULL) +
  theme(axis.text.y = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.ticks.y = element_blank(), 
        legend.position="none")

ggplot(v1_lin_fitted, aes(index, 
                          resc_std, 
                          color = subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0)

ggplot(v1_lin_fitted, 
       aes(sample = resc_std)) + 
  geom_qq() + 
  geom_qq_line(color = "red")

ggplot(v1_lin_lcr, 
       aes(sample = reslc_lin)) + 
  geom_qq() + 
  geom_qq_line(color = "red")
```

- The marginal residual seems to be scaled down as the outliers on the M4 subject and also one outlier in F3 subject.
- The conditional residual seems to be normal and fewer outliers.
- The conditional residual does not follow a normal distribution as there is a huge jump at the top.
- The least confounded residual does not follow a normal distribution as well, since there is a jump at the middle and a heavy tail.








### 1st replication

```{r v11-sim}
v11_sim <- lin_sim(v1_lin_mod, v1_lin, seed = 1234)
```

```{r fittednull-v11}
v11_lin_sim_fitted <- std_res(v11_sim)
```

```{r lcrsimnull-v11}
v11_lin_sim_lcr <- lcr_res(v11_sim)
```

#### Lineups

```{r v11n-plot}
lineup(true = v1_lin_fitted, 
       samples = v11_lin_sim_fitted, 
       pos = 9) %>% 
  ggplot(aes(interaction(attitude, gender), 
             resm_std)) +
  geom_boxplot() +
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + 
  ylab(NULL) +
  theme(axis.text.y = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v11n-plot21}
l11.1 <- lineup(true = v1_lin_fitted,
                samples = v11_lin_sim_fitted,
                pos = 7) %>%
  ggplot(aes(index,
             resm_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v11_1.png",
  plot = l11.1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v11n-plot22}
lineup(true = v1_lin_fitted, 
       samples = v11_lin_sim_fitted, 
       pos = 7) %>% 
  ggplot(aes(index, 
             resm_std, 
             color = scenario)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5)
```


```{r v11n-plot4}
l11.2 <- lineup(true = v1_lin_fitted,
                samples = v11_lin_sim_fitted,
                pos = 7) %>%
  ggplot(aes(index,
             resc_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v11_2.png",
  plot = l11.2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v11n-plot5}
lineup(true = v1_lin_fitted, 
       samples = v11_lin_sim_fitted, 
       pos = 9) %>% 
  ggplot(aes(fitted, 
             resc_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```

```{r v11n-plot6}
l11.3 <- lineup(true = v1_lin_fitted,
                samples = v11_lin_sim_fitted,
                pos = 9) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v11_3.png",
  plot = l11.3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
l11.4 <- lineup(true = v1_lin_lcr,
                samples = v11_lin_sim_lcr,
                pos = 9) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v11_4.png",
  plot = l11.4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


### 2nd replication

```{r v12-sim}
v12_sim <- lin_sim(v1_lin_mod, v1_lin, seed = 2492)
```

```{r fittednull-v12}
v12_lin_sim_fitted <- std_res(v12_sim)
```

```{r lcrsimnull-v12}
v12_lin_sim_lcr <- lcr_res(v12_sim)
```

#### Lineups

```{r v12n-plot1}
lineup(true = v1_lin_fitted, 
       samples = v12_lin_sim_fitted, 
       pos = 7) %>% 
  ggplot(aes(interaction(attitude, gender), 
             resm_std)) +
  geom_boxplot() +
  facet_wrap(~.sample, ncol = 5)
```

```{r v12n-plot2}
l12_1 <- lineup(true = v1_lin_fitted,
                samples = v12_lin_sim_fitted,
                pos = 7) %>%
  ggplot(aes(index,
             resm_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v12_1.png",
  plot = l12_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


```{r v12n-plot4}
l12_2 <- lineup(true = v1_lin_fitted,
                samples = v12_lin_sim_fitted,
                pos = 7) %>%
  ggplot(aes(index,
             resc_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v12_2.png",
  plot = l12_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v12n-plot5}
lineup(true = v1_lin_fitted, 
       samples = v12_lin_sim_fitted, 
       pos = 9) %>% 
  ggplot(aes(fitted, 
             resc_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```

```{r v12n-plot6}
l12_3 <- lineup(true = v1_lin_fitted,
                samples = v12_lin_sim_fitted,
                pos = 9) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v12_3.png",
  plot = l12_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v12n-plot-lcr}
l12_4 <- lineup(true = v1_lin_lcr,
                samples = v12_lin_sim_lcr,
                pos = 9) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v12_4.png",
  plot = l12_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### 3st replication

```{r v13-sim}
v13_sim <- lin_sim(v1_lin_mod, v1_lin, seed = 9876)
```

```{r fittednull-v13}
v13_lin_sim_fitted <- std_res(v13_sim)
```

```{r lcrsimnull-v13}
v13_lin_sim_lcr <- lcr_res(v13_sim)
```

#### Lineups

```{r v13n-plot1}
lineup(true = v1_lin_fitted,
       samples = v13_lin_sim_fitted,
       pos = 9) %>%
  ggplot(aes(interaction(attitude, gender), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5)
```

```{r v13n-plot21}
l13_1 <- lineup(true = v1_lin_fitted,
                samples = v13_lin_sim_fitted,
                pos = 13) %>%
  ggplot(aes(index,
             resm_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v13_1.png", 
  plot = l13_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


```{r v13n-plot4}
l13_2 <- lineup(true = v1_lin_fitted,
                samples = v13_lin_sim_fitted,
                pos = 13) %>%
  ggplot(aes(index,
             resc_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v13_2.png",
  plot = l13_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v13n-plot5}
lineup(true = v1_lin_fitted, 
       samples = v13_lin_sim_fitted, 
       pos = 9) %>% 
  ggplot(aes(fitted, 
             resc_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```

```{r v13n-plot6}
l13_3 <- lineup(true = v1_lin_fitted,
                samples = v13_lin_sim_fitted,
                pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v13_3.png",
  plot = l13_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v13n-plot-lcr}
l13_4 <- lineup(true = v1_lin_lcr,
                samples = v13_lin_sim_lcr,
                pos = 4) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v13_4.png",
  plot = l13_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### 4th replication

```{r v14-sim}
v14_sim <- lin_sim(v1_lin_mod, v1_lin, seed = 6839)
```

```{r fittednull-v14}
v14_lin_sim_fitted <- std_res(v14_sim)
```

```{r lcrsimnull-v14}
v14_lin_sim_lcr <- lcr_res(v14_sim)

```

#### Lineups

```{r v14n-plot1}
lineup(true = v1_lin_fitted,
       samples = v14_lin_sim_fitted,
       pos = 9) %>%
  ggplot(aes(interaction(attitude,
                         gender), resm_std)) +
  geom_boxplot() +
  facet_wrap(~ .sample, ncol = 5)
```

```{r v14n-plot21}
l14_1 <- lineup(true = v1_lin_fitted,
                samples = v14_lin_sim_fitted,
                pos = 13) %>%
  ggplot(aes(index,
             resm_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
 path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v14_1.png",
  plot = l14_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v14n-plot4}
l14_2 <- lineup(true = v1_lin_fitted,
                samples = v14_lin_sim_fitted,
                pos = 13) %>%
  ggplot(aes(index,
             resc_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v14_2.png",
  plot = l14_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

- the conditional residual plot is less able to be identified than the marginal residiual

```{r v14n-plot5}
lineup(true = v1_lin_fitted, 
       samples = v14_lin_sim_fitted, 
       pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```

```{r v14n-plot6}
l14_3 <- lineup(true = v1_lin_fitted,
                samples = v14_lin_sim_fitted,
                pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v14_3.png",
  plot = l14_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v14n-plot-lcr}

l14_4 <- lineup(true = v1_lin_lcr,
                samples = v14_lin_sim_lcr,
                pos = 4) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version1/"),
  filename = "lin_v14_4.png",
  plot = l14_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

- Overall, it maybe the case that the least confounded residual is easier to be identified compared to standardised conditional residual based on version 1.

## *Version 2

I added the student t distribution to the error term.

```{r}
set.seed(1234)
# multivariate t error term
e <- as.vector(rmvt(1, sigma = R, df = 1))
y <- as.vector(getME(fit, "X") %*% fixef(fit) + getME(fit, "Z") %*% b + e)
v2_lin <- tibble(df[,-5], y)
```

```{r v2mod}
v2_lin_mod <- lmer(y ~ attitude + gender + 
              (1|subject) + (1|scenario),
            data = v2_lin)
```

```{r v2-extract}
v2_lin_fitted <- lin_extract_fitted_mod(v2_lin_mod, v2_lin)
v2_lin_lcr <- lin_extract_lcr_mod(v2_lin_mod, v2_lin)
```

# Data plots

```{r v2-plots}
lin21 <-
  ggplot(v2_lin_fitted, aes(index, resm_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )
ggplot(v2_lin_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")
ggplot(v2_lin_lcr, aes(sample = reslc_lin)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

- There are more outlying observations presented in F3 subject compared with version 1
- The subject M4 and M3 are not well fitted under the conditional residuals
- Both conditional residual and conditional residual are not normally distributed.


### 1st replication

```{r v21-sim}
v21_sim <- lin_sim(v2_lin_mod, v2_lin, seed = 1234)
```

```{r fittednull-v21}
v21_lin_sim_fitted <- std_res(v21_sim)
```

```{r lcrsimnull-v21}
v21_lin_sim_lcr <- lcr_res(v21_sim)
```

#### Lineups

```{r v21n-plot}
lineup(true = v2_lin_fitted, 
       samples = v21_lin_sim_fitted, 
       pos = 9) %>% 
  ggplot(aes(interaction(attitude, gender), 
             resm_std)) +
  geom_boxplot() +
  facet_wrap(~.sample, ncol = 5)
```

##### Outlying observations

```{r v21n-plot21}
l21_1 <- lineup(true = v2_lin_fitted,
                samples = v21_lin_sim_fitted,
                pos = 5) %>%
  ggplot(aes(index,
             resm_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v21_1.png",
  plot = l21_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


```{r v21n-plot4}
l21_2 <- lineup(true = v2_lin_fitted,
                samples = v21_lin_sim_fitted,
                pos = 5) %>%
  ggplot(aes(index, resc_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v21_2.png",
  plot = l21_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

##### Checking normality

```{r v21n-plot6}
l21_3 <- lineup(true = v2_lin_fitted,
                samples = v21_lin_sim_fitted,
                pos = 8) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v21_3.png",
  plot = l21_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v21n-plot6-lcr}
l21_4 <- lineup(true = v2_lin_lcr,
                samples = v21_lin_sim_lcr,
                pos = 8) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v21_4.png",
  plot = l21_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### 2nd replication
```{r v22-sim}
v22_sim <- lin_sim(v2_lin_mod, v2_lin, seed = 2632)
```

```{r fittednull-v22}
v22_lin_sim_fitted <- std_res(v22_sim)
```

```{r lcrsimnull-v22}
v22_lin_sim_lcr <- lcr_res(v22_sim)
```

#### Lineups

```{r v22n-plot}
lineup(true = v2_lin_fitted, samples = v22_lin_sim_fitted, pos = 9) %>% 
  ggplot(aes(interaction(attitude, gender), 
             resm_std)) + 
  geom_boxplot() +
  facet_wrap(~.sample, ncol = 5)
```

##### Outlying observations

```{r v22n-plot22}
l22_1 <- lineup(true = v2_lin_fitted,
                samples = v22_lin_sim_fitted,
                pos = 5) %>%
  ggplot(aes(index,
             resm_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v22_1.png",
  plot = l22_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v22n-plot4}
l22_2 <- lineup(true = v2_lin_fitted,
                samples = v22_lin_sim_fitted,
                pos = 5) %>%
  ggplot(aes(index,
             resc_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v22_2.png",
  plot = l22_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

##### Checking normality

```{r v21n-plot6}
l22_3 <- lineup(true = v2_lin_fitted,
                samples = v22_lin_sim_fitted,
                pos = 8) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v22_3.png",
  plot = l22_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v21n-plot6-lcr}
l22_4 <- lineup(true = v2_lin_lcr,
                samples = v22_lin_sim_lcr,
                pos = 8) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v22_4.png",
  plot = l22_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### 3rd replication
```{r v21-sim}
v23_sim <- lin_sim(v2_lin_mod, v2_lin, seed = 7374)
```

```{r fittednull-v21}
v23_lin_sim_fitted <- std_res(v23_sim)
```

```{r lcrsimnull-v23}
v23_lin_sim_lcr <- lcr_res(v23_sim)
```

#### Lineups

```{r v23n-plot}
lineup(true = v2_lin_fitted, 
       samples = v23_lin_sim_fitted, 
       pos = 9) %>% 
  ggplot(aes(interaction(attitude, gender), 
             resm_std)) +
  geom_boxplot() +
  facet_wrap(~.sample, ncol = 5)
```

##### Presence of outlying observations

```{r v23n-plot21}
l23_1 <- lineup(true = v2_lin_fitted,
                samples = v23_lin_sim_fitted,
                pos = 15) %>%
  ggplot(aes(index,
             resm_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v23_1.png",
  plot = l23_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v23n-plot}
l23_2 <- lineup(true = v2_lin_fitted,
                samples = v23_lin_sim_fitted,
                pos = 15) %>%
  ggplot(aes(index,
             resc_std,
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v23_2.png",
  plot = l23_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```
##### Checking normality

```{r v23n-plot6}
l23_3 <- lineup(true = v2_lin_fitted,
                samples = v23_lin_sim_fitted,
                pos = 20) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v23_3.png",
  plot = l23_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v21n-plot6-lcr}
l23_4 <-
  lineup(true = v2_lin_lcr,
         samples = v23_lin_sim_lcr,
         pos = 20) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v23_4.png",
  plot = l23_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### 4th replication
```{r v21-sim}
v24_sim <- lin_sim(v2_lin_mod, v2_lin, seed = 8821)
```

```{r fittednull-v21}
v24_lin_sim_fitted <- std_res(v24_sim)
```

```{r lcrsimnull-v24}
v24_lin_sim_lcr <- lcr_res(v24_sim)
```

#### Lineups

```{r v24n-plot}
lineup(true = v2_lin_fitted,
       samples = v24_lin_sim_fitted,
       pos = 9) %>%
  ggplot(aes(interaction(attitude, gender), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5)
```

##### Presence of outlying observations
```{r v21n-plot21}
l24_1 <-
  lineup(true = v2_lin_fitted,
         samples = v24_lin_sim_fitted,
         pos = 15) %>%
  ggplot(aes(index, 
             resm_std, 
             color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v24_1.png",
  plot = l24_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v24n-plot}
l24_2 <-
  lineup(true = v2_lin_fitted,
         samples = v24_lin_sim_fitted,
         pos = 15) %>%
  ggplot(aes(index, resc_std, color = subject)) + geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v24_2.png",
  plot = l24_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

##### Checking normality

```{r v24n-plot6}
l24_3 <-
  lineup(true = v2_lin_fitted,
         samples = v24_lin_sim_fitted,
         pos = 20) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v24_3.png",
  plot = l24_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v24n-plot6-lcr}
l24_4 <-
  lineup(true = v2_lin_lcr,
         samples = v24_lin_sim_lcr,
         pos = 20) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version2/"),
  filename = "lin_v24_4.png",
  plot = l24_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## Version 3

We randomly added 100 value to `y` as the mean is around 200.

```{r}
set.seed(194253)
samp5 <- sample(21, 1)
f_pol <-
  round(as.numeric(
    df %>% filter(gender == "F", attitude == "pol") %>% summarise(mean(y))
  ), 1)
repc_f_pol <- df %>%
  filter(gender == "F", 
         attitude == "pol")

repc_f_pol[c(samp5), ]$y <- repc_f_pol[c(samp5), ]$y + f_pol * 0.2
```

```{r}
set.seed(107623)
samp6 <- sample(21, 1)
m_pol <-
  round(as.numeric(
    df %>% 
      filter(gender == "M", 
             attitude == "pol") %>% 
      summarise(mean(y))
  ), 1)
repc_m_pol <- df %>% 
  filter(gender == "M", 
        attitude == "pol")

repc_m_pol[c(samp6),]$y <- repc_m_pol[c(samp6),]$y + m_pol * 0.2
```

```{r}
set.seed(274302)
samp7 <- sample(21, 1)

m_inf <-
  round(as.numeric(
    df %>% 
      filter(gender == "M", 
      attitude == "inf") %>% 
      summarise(mean(y))
  ), 1)

repc_m_inf <- df %>% 
  filter(gender == "M", 
         attitude == "inf")

repc_m_inf[c(samp7), ]$y <- repc_m_inf[c(samp7), ]$y + m_inf * 0.2
```

```{r}
set.seed(981234)
samp8 <- sample(21, 1)
f_inf <-
  round(as.numeric(
    df %>% 
      filter(gender == "F", 
             attitude == "inf") %>% 
      summarise(mean(y))
  ), 1)
repc_f_inf <- df %>% 
  filter(gender == "F", 
         attitude == "inf")
repc_f_inf[c(samp8), ]$y <- repc_f_inf[c(samp8), ]$y + f_inf * 0.2
```

```{r}
repc3 <- rbind(repc_f_inf, 
               repc_f_pol, 
               repc_m_inf, 
               repc_m_pol)

v3_lin <- repc3[order(repc3$subject),]
```

```{r v3.mod}
v3_lin_mod <- lmer(y ~ attitude + gender + 
              (1|subject) + (1|scenario),
            data = v3_lin)
```

```{r}
v3_lin_fitted <- lin_extract_fitted_mod(v3_lin_mod, v3_lin)
v3_lin_lcr <- lin_extract_lcr_mod(v3_lin_mod, v3_lin)
```


```{r}
ggplot(v3_lin_fitted, aes(index, 
                          resm_std, 
                          color = subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0)

lin_dp2 <-
  ggplot(v3_lin_fitted, 
         aes(index, 
             resc_std, 
             color = subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) + 
  ylab("Standardised conditional residuals") + 
  xlab("Observations index") + 
  theme()

lin_dp3 <-ggplot(v3_lin_fitted, 
                 aes(sample = resc_std)) + 
  geom_qq() + 
  geom_qq_line(color = "red") + 
  xlab(NULL) + 
  ylab(NULL) + 
  theme()

ggplot(v3_lin_lcr, aes(sample = reslc_lin)) + 
  geom_qq() + 
  geom_qq_line(color = "red")
```

- The outlying observations are shown in both marginal residual and conditional residuals
- The conditional residual does not follow a normal distribution while the least confounded residual follows a normal distribution.

## 1st replication

```{r}
v31_sim <- lin_sim(v3_lin_mod, v3_lin, seed = 1234)
```

```{r fittednull-v31}
v31_lin_sim_fitted <- std_res(v31_sim)
```

```{r lcrsimnull-v31}
v31_lin_sim_lcr <- lcr_res(v31_sim)
```

#### Lineups

##### Detecting outlying observations

```{r v31n-plot21, fig.height=6}
l31_1 <-
  lineup(true = v3_lin_fitted,
         samples = v31_lin_sim_fitted,
         pos = 15) %>%
  ggplot(aes(index, resm_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v31_1.png",
  plot = l31_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v31n-plot4, fig.height=6}
l31_2 <-
  lineup(true = v3_lin_fitted,
         samples = v31_lin_sim_fitted,
         pos = 15) %>%
  ggplot(aes(index, resc_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v31_2.png",
  plot = l31_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

##### Checking normality

```{r v31n-plot6, fig.height=6}
l31_3 <-
  lineup(true = v3_lin_fitted,
         samples = v31_lin_sim_fitted,
         pos = 11) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v31_3.png",
  plot = l31_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v32n-plot6-lcr, fig.height=6}
l31_4 <-
  lineup(true = v3_lin_lcr,
         samples = v31_lin_sim_lcr,
         pos = 11) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v31_4.png",
  plot = l31_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 2nd replication

```{r}
v32_sim <- lin_sim(v3_lin_mod, v3_lin, seed = 4252)
```

```{r fittednull-v32}
v32_lin_sim_fitted <- std_res(v32_sim)
```

```{r lcrsimnull-v32}
v32_lin_sim_lcr <- lcr_res(v32_sim)
```

#### Lineups

##### Detecting outlying observations

```{r v32n-plot21, fig.height=6}
l32_1 <-
  lineup(true = v3_lin_fitted,
         samples = v32_lin_sim_fitted,
         pos = 15) %>%
  ggplot(aes(index, resm_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v32_1.png",
  plot = l32_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v32n-plot4, fig.height=6}
l32_2 <-
  lineup(true = v3_lin_fitted,
         samples = v32_lin_sim_fitted,
         pos = 15) %>%
  ggplot(aes(index, resc_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v32_2.png",
  plot = l32_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

##### Checking normality

```{r v31n-plot6, fig.height=6}
l32_3 <-
  lineup(true = v3_lin_fitted,
         samples = v32_lin_sim_fitted,
         pos = 11) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v32_3.png",
  plot = l32_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v32n-plot6-lcr, fig.height=6}
l32_4 <-
  lineup(true = v3_lin_lcr,
         samples = v32_lin_sim_lcr,
         pos = 11) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v32_4.png",
  plot = l32_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 3rd replication

```{r}
v33_sim <- lin_sim(v3_lin_mod, v3_lin, seed = 9263)
```

```{r fittednull-v32}
v33_lin_sim_fitted <- std_res(v33_sim)
```

```{r lcrsimnull-v32}
v33_lin_sim_lcr <- lcr_res(v33_sim)
```

#### Lineups

##### Detecting outlying observations

```{r v33n-plot21, fig.height=6}
l33_1 <-
  lineup(true = v3_lin_fitted,
         samples = v33_lin_sim_fitted,
         pos = 2) %>%
  ggplot(aes(index, resm_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v33_1.png",
  plot = l33_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v32n-plot4, fig.height=6}
l33_2 <-
  lineup(true = v3_lin_fitted,
         samples = v33_lin_sim_fitted,
         pos = 2) %>%
  ggplot(aes(index, resc_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v33_2.png",
  plot = l33_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

##### Checking normality

```{r v31n-plot6, fig.height=6}
l33_3 <-
  lineup(true = v3_lin_fitted,
         samples = v33_lin_sim_fitted,
         pos = 6) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v33_3.png",
  plot = l33_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v32n-plot6-lcr, fig.height=6}
l33_4 <-
  lineup(true = v3_lin_lcr,
         samples = v33_lin_sim_lcr,
         pos = 6) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v33_4.png",
  plot = l33_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 4th replication

```{r}
v34_sim <- lin_sim(v3_lin_mod, v3_lin, seed = 1508)
```

```{r fittednull-v34}
v34_lin_sim_fitted <- std_res(v34_sim)
```

```{r lcrsimnull-v32}
v34_lin_sim_lcr <- lcr_res(v34_sim)
```

#### Lineups

##### Detecting outlying observations

```{r v32n-plot21, fig.height=6}
l34_1 <-
  lineup(true = v3_lin_fitted,
         samples = v34_lin_sim_fitted,
         pos = 2) %>%
  ggplot(aes(index, resm_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v34_1.png",
  plot = l34_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v32n-plot4, fig.height=6}
l34_2 <-
  lineup(true = v3_lin_fitted,
         samples = v34_lin_sim_fitted,
         pos = 2) %>%
  ggplot(aes(index, resc_std, color = subject)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v34_2.png",
  plot = l34_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

##### Checking normality

```{r v31n-plot6, fig.height=6}
l34_3 <-
  lineup(true = v3_lin_fitted,
         samples = v34_lin_sim_fitted,
         pos = 6) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v34_3.png",
  plot = l34_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v32n-plot6-lcr, fig.height=6}
l34_4 <-
  lineup(true = v3_lin_lcr,
         samples = v34_lin_sim_lcr,
         pos = 6) %>%
  ggplot(aes(sample = reslc_lin)) +
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~ .sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/linguistic/version3/"),
  filename = "lin_v34_4.png",
  plot = l34_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


