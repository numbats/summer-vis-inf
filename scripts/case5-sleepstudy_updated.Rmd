---
title: "case5"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(mvtnorm)
library(dplyr)
library(tidyverse)
library(plyr)
library(nullabor)
library(MASS)
```

```{r}
data("sleepstudy")
head(sleepstudy)
skimr::skim(sleepstudy)
summary(sleepstudy)
```

```{r}
ggplot(sleepstudy, aes(Days, Reaction)) + geom_point() + facet_wrap(~Subject) + geom_smooth(method = "lm", se = FALSE) + ylab("Reaction")

ggplot(sleepstudy, aes(Subject, Reaction)) + geom_boxplot()
```

```{r}
testrandom <- plyr::ddply(sleepstudy, .(Subject), function(x) {
  m <- lm(Reaction ~ Days, data = x)
  data.frame(x, fitted = fitted(m))	
})

ggplot(testrandom, aes(Days, fitted, group = Subject)) + geom_line()
```

Therefore, from the plots, the model needs the random intercept and random slope.

```{r}
# random intercept and random slope
slmod1 <- lmer(Reaction ~ Days + (Days|Subject), data = sleepstudy)
# independent random effects
slmod2 <- lmer(Reaction ~ Days + (Days -1 |Subject) + (1|Subject), data = sleepstudy)
#summary(slmod1)
#summary(slmod2)

set.seed(987654321)
sl.mod2.sims  <- simulate(slmod2, nsim = 19)
sl.mod2.refit <- lapply(sl.mod2.sims, refit, object = slmod2)
sl.mod2.sim.ranef <- lapply(sl.mod2.refit, function(x) ranef(x)[[1]])
sl.mod2.sim.ranef <- do.call("rbind", sl.mod2.sim.ranef)
sl.mod2.sim.ranef$.n <- rownames(sl.mod2.sim.ranef)
sl.mod2.sim.ranef$.n <- as.numeric(str_extract(sl.mod2.sim.ranef$.n, "\\d+"))
true.sl.mod1.ranef <- ranef(slmod1)$Subject
sl_df <- nullabor:::add_true(sl.mod2.sim.ranef, true.sl.mod1.ranef, pos = 9)
ggplot(data = sl_df, aes(x = `(Intercept)`, y = Days)) + 
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, alpha = 0.4) +
  facet_wrap( ~ .sample, ncol=5) + 
  xlab(NULL) + 
  ylab(NULL)

```

Since the true plot is indistinguishable from the null plots, there is no need for the correlation between the random effects.

Hence the model is shown in `slmod2`.

From the true model, replicating the data for 4 times by $y \sim (X\beta, \Omega)$, where $\Omega = Z\Gamma Z^\top + R$ and refitting the model with $y = X\beta + Zb + e$ and get the plots & null plots.

- Version 1: 'best' model
- Version 2: slight noise (error is correlated such as `kronecker(diag(3), matrix(1, nrow = 2, ncol = 2))`, sample from the data by adding small values to the sample data)
- Version 3: Extreme value (with obvious outlier but not that obvious)

Since $M_i$ are the same for each case, the plot 7 and 8 are ignored!

$$\boldsymbol y \sim N(X\beta, Z \Gamma Z^\top + R)$$

```{r fitfn}
sl.extract.fitted <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[,1], ranef(mod)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted_df <- data %>% 
    dplyr::mutate(
      fitted = as.vector(X %*% beta),
      resm = y - fitted,
      resc = as.vector(y - fitted - Z %*% u),
      index = 1:n()) %>% 
    mutate(resm_std = resm/sqrt(diag(varMargRes)[index]),
           resc_std = resc/sqrt(diag(varCondRes)[index])) %>% 
    ungroup()
  
  return(fitted_df)
}
```

```{r lcrfn}
sl.extract.lcr <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[,1], ranef(mod)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted <-  as.vector(X %*% beta)
  resm <-  y - fitted
  resc <-  as.vector(y - fitted - Z %*% u)
  index <- 1:nrow(data)
  resm_std <-  resm/sqrt(diag(varMargRes)[index])
  resc_std = resc/sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))

  resmcp_sl <- tibble::tibble(resmcp)
  
  return(resmcp_sl)
}
```

```{r simulate}
sl.sim <- function(mod, data, nsim = 19, seed, std = FALSE){
  fit.sim <- simulate(mod, nsim = nsim, seed = seed)
  fit.refit <- lapply(fit.sim, refit, object = mod)
  fit.simy <- lapply(fit.refit, function(x) getME(x, 'y'))
  fit.simy.y <- do.call("cbind", fit.simy)
  fit.simy.y <- reshape2::melt(fit.simy.y)[-1]
  names(fit.simy.y) <- c(".n", "y")
  fit.simy.y$.n <- as.numeric(str_extract(fit.simy.y$.n, "\\d+"))
  fit.simy.y$Subject <- rep(data$Subject, 19)
  fit.simy.y$Days <- rep(data$Days, 19)
  return(fit.simy.y)
}
```

```{r}
colnames(sleepstudy)[1] <- c("y")
sl.fitted <- sl.extract.fitted(slmod2, sleepstudy)
sl.lcr <- sl.extract.lcr(slmod2, sleepstudy)
```

```{r}
ggplot(sl.fitted, aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) + geom_text(data = sl.fitted %>% filter(resm_std>2), aes(label = index), nudge_x = 0.35, nudge_y = 0.35, size = 2)
ggplot(sl.fitted, aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) + geom_text(data = sl.fitted %>% filter(abs(resc_std)>3), aes(label = index), nudge_x = 0.35, nudge_y = 0.35, size = 2)
ggplot(sl.fitted, aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red")
ggplot(sl.lcr, aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red")
```

- There is no evidence showing the presence of outlying observations.
- The the index for 8, 57 and 60 are the outlying observations in the reaction values for conditional residuals. 
  + Index 8 shows a significant drop at day 7 for subject 308
  + Index 57 shows an increase at day 6 for subject 332
  + Index 60 shows a drop at day 9 for subject 332
- Plot 6 shows the Gaussian QQ plot for the conditional residuals. However, from the plot, there are obvious tails. One extreme point on the upper end and two on the lower end may seem exceptional. The conditonal residuals might not follow a normal distribution.
- Plot 7 shows the Gaussian QQ plot for the least confounded residuals. There also shows some tails.


## Version 3

I randomly insert 40% of the mean value of response value in `sleepstudy` to two of each subject.

```{r}
set.seed(1234)
samp_df <- tibble(sleepstudy %>% group_by(Subject) %>% sample_n(size = 2))
samp_df$y <- samp_df$y + mean(sleepstudy$y)*0.40

rest_df <- anti_join(sleepstudy, samp_df, by = c("Days", "Subject"))

d <- rbind(samp_df, rest_df)
v3.sl <- d %>% arrange(Subject, Days)
```

```{r}
v3.sl.mod <- lmer(y ~ Days + (Days - 1|Subject) + (1|Subject), data = v3.sl)

v3.sl.fitted <- sl.extract.fitted(v3.sl.mod, v3.sl)
v3.sl.lcr <- sl.extract.lcr(v3.sl.mod, v3.sl)
```

#### Data plots

```{r}
ggplot(v3.sl.fitted, aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) + geom_text(data = v3.sl.fitted %>% filter(resm_std>3), aes(label = index), nudge_x = 0.35, nudge_y = 0.35, size = 2)
slp_dp2_updated <- ggplot(v3.sl.fitted, aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) + geom_text(data = v3.sl.fitted %>% filter(abs(resc_std)>3), aes(label = index), nudge_x = 0.35, nudge_y = 0.35, size = 2) + ylab("Standardised conditional residuals") + theme()
slp_dp2
ggsave(path= here::here("figures/second/"),filename = "slp_dp2_updated.png", plot = slp_dp2, device = "png", dpi = 300)

ggplot(v3.sl.fitted, aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red")
ggplot(v3.sl.lcr, aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red")
```

- There is one obvious outliers in the marginal residuals
- There are 3 obvious outliers in the conditional residuals
- Both are not normally distributed.


### 1st replication

#### Simulation
```{r}
v31.sl.sim <- sl.sim(v3.sl.mod, v3.sl, seed = 1253)
```

```{r nullfitted-v31}
v31.sl.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v31.sl.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v31}
v31.sl.simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v31.sl.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```


##### Lineup plots

```{r v31n-plo2, fig.height=6}
s31.1 <- lineup(true = v3.sl.fitted, samples = v31.sl.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + 
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")

ggsave(path= here::here("figures/lineup/"),filename = "slp_v31_1_updated.png", 
  plot = s31.1, device = "png", dpi = 300,
  height = 12, width = 12)
```

```{r v31n-plo4, fig.height=6}
s31.2 <- lineup(true = v3.sl.fitted, samples = v31.sl.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + 
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")

ggsave(path= here::here("figures/lineup/"),filename = "slp_v31_2_updated.png", 
  plot = s31.2, device = "png", dpi = 300,
  height = 12, width = 12)
```

```{r v31n-plo6, fig.height=6}
s31.3 <- lineup(true = v3.sl.fitted, samples = v31.sl.sim.fitted, pos = 11) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none", aspect.ratio = 1)

ggsave(path= here::here("figures/lineup/"),filename = "slp_v31_3_updated.png", 
  plot = s31.3, device = "png", dpi = 300,
  height = 12, width = 12)
```

```{r v31n-plo6-lcr, fig.height=6}
s31.4 <- lineup(true = v3.sl.lcr, samples = v31.sl.simlcr, pos = 11) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none", aspect.ratio = 1)

ggsave(path= here::here("figures/lineup/"),filename = "slp_v31_4_updated.png", 
  plot = s31.4, device = "png", dpi = 300,
  height = 12, width = 12)
```


### 2nd replication

#### Simulation

```{r}
v32.sl.sim <- sl.sim(v3.sl.mod, v3.sl, seed = 2353)
```

```{r nullfitted-v32}
v32.sl.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v32.sl.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v32}
v32.sl.simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v32.sl.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

##### Lineup plots

```{r v32n-plo2, fig.height=6}
s32.1 <- lineup(true = v3.sl.fitted, samples = v32.sl.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")

ggsave(path= here::here("figures/lineup/"),filename = "slp_v32_1_updated.png", 
  plot = s32.1, device = "png", dpi = 300,
  height = 12, width = 12)
```

```{r v32n-plo4, fig.height=6}
s32.2 <- lineup(true = v3.sl.fitted, samples = v32.sl.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")

ggsave(path= here::here("figures/lineup/"),filename = "slp_v32_2_updated.png", 
  plot = s32.2, device = "png", dpi = 300,
  height = 12, width = 12)
```


```{r v32n-plo6, fig.height=6}
s32.3 <- lineup(true = v3.sl.fitted, samples = v32.sl.sim.fitted, pos = 11) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none", aspect.ratio = 1)

ggsave(path= here::here("figures/lineup/"),filename = "slp_v32_3_updated.png", 
  plot = s32.3, device = "png", dpi = 300,
  height = 12, width = 12)
```


```{r v32n-plo6-lcr, fig.height=6}
s32.4 <- lineup(true = v3.sl.lcr, samples = v32.sl.simlcr, pos = 11) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none", aspect.ratio = 1)

ggsave(path= here::here("figures/lineup/"),filename = "slp_v32_4_updated.png", 
  plot = s32.4, device = "png", dpi = 300,
  height = 12, width = 12)
```

### 3rd replication

#### Simulation

```{r}
v33.sl.sim <- sl.sim(v3.sl.mod, v3.sl, seed = 4792)
```

```{r nullfitted-v33}
v33.sl.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v33.sl.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v33}
v33.sl.simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v33.sl.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

##### Lineup plots

```{r v33n-plo2, fig.height=6}
s33.1 <- lineup(true = v3.sl.fitted, samples = v33.sl.sim.fitted, pos = 2) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")

ggsave(path= here::here("figures/lineup/"),filename = "slp_v33_1_updated.png", 
  plot = s33.1, device = "png", dpi = 300,
  height = 12, width = 12)
```


```{r v33n-plo4, fig.height=6}
s33.2 <- lineup(true = v3.sl.fitted, samples = v33.sl.sim.fitted, pos = 2) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")

ggsave(path= here::here("figures/lineup/"),filename = "slp_v33_2_updated.png", 
  plot = s33.2, device = "png", dpi = 300,
  height = 12, width = 12)
```



```{r v33n-plo6, fig.height=6}
s33.3 <- lineup(true = v3.sl.fitted, samples = v33.sl.sim.fitted, pos = 6) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none", aspect.ratio = 1) 

ggsave(path= here::here("figures/lineup/"),filename = "slp_v33_3_updated.png", 
  plot = s33.3, device = "png", dpi = 300,
  height = 12, width = 12)
```

true plot is identified, the conditional residual does not follow a normal distribution.

```{r v33n-plo6-lcr, fig.height=6}
s33.4 <- lineup(true = v3.sl.lcr, samples = v33.sl.simlcr, pos = 6) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none", aspect.ratio = 1)

ggsave(path= here::here("figures/lineup/"),filename = "slp_v33_4_updated.png", 
  plot = s33.4, device = "png", dpi = 300,
  height = 12, width = 12)
```


### 4th replication

#### Simulation

```{r}
v34.sl.sim <- sl.sim(v3.sl.mod, v3.sl, seed = 9865)
```

```{r nullfitted-v34}
v34.sl.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v34.sl.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v34}
v34.sl.simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v34.sl.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```


##### Lineup plots

```{r v34n-plo2, fig.height=6}
s34.1 <- lineup(true = v3.sl.fitted, samples = v34.sl.sim.fitted, pos = 2) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")

ggsave(path= here::here("figures/lineup/"),filename = "slp_v34_1_updated.png", 
  plot = s34.1, device = "png", dpi = 300,
  height = 12, width = 12)
```

```{r v34n-plo4, fig.height=6}
s34.2 <- lineup(true = v3.sl.fitted, samples = v34.sl.sim.fitted, pos = 2) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")

ggsave(path= here::here("figures/lineup/"),filename = "slp_v34_2_updated.png", 
  plot = s34.2, device = "png", dpi = 300,
  height = 12, width = 12)
```


```{r v34n-plo6, fig.height=6}
s34.3 <- lineup(true = v3.sl.fitted, samples = v34.sl.sim.fitted, pos = 6) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none", aspect.ratio = 1)

ggsave(path= here::here("figures/lineup/"),filename = "slp_v34_3_updated.png", 
  plot = s34.3, device = "png", dpi = 300,
  height = 12, width = 12)
```


```{r v34n-plo6-lcr, fig.height=6}
s34.4 <- lineup(true = v3.sl.lcr, samples = v34.sl.simlcr, pos = 6) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none", aspect.ratio = 1)

ggsave(path= here::here("figures/lineup/"),filename = "slp_v34_4_updated.png", 
  plot = s34.4, device = "png", dpi = 300,
  height = 12, width = 12)
```

- For version 3, the conditional residual is easier to be detected.







