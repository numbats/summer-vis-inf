---
title: "case5"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(mvtnorm)
library(dplyr)
library(tidyverse)
library(plyr)
library(nullabor)
library(MASS)
```

```{r data}
# Data and its summary
data("sleepstudy")
head(sleepstudy)
skimr::skim(sleepstudy)
summary(sleepstudy)
```

```{r graphical-summary}

# Linear Model on each subject's reaction over days
ggplot(sleepstudy, aes(Days, Reaction)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE) +
  ylab("Reaction")

# Each subject's reaction
ggplot(sleepstudy, aes(Subject, Reaction)) +
  geom_boxplot()
```

```{r fitted-values}

testrandom <- plyr::ddply(sleepstudy, .(Subject), function(x) {
  m <- lm(Reaction ~ Days, data = x)
  data.frame(x, fitted = fitted(m)) # fitted mean values from Reaction ~ Days linear model added to data frame
})

# fitted values plotted against 10 days for each of 18 subjects

ggplot(
  testrandom,
  aes(Days, fitted, group = Subject)
) +
  geom_line()
```

Therefore, from the plots, the model needs the random intercept and random slope.

```{r random-intercept}

# random intercept and random slope
slmod1 <- lmer(Reaction ~ Days + (Days | Subject), data = sleepstudy)

# independent random effects
slmod2 <- lmer(Reaction ~ Days + (Days - 1 | Subject) +
  (1 | Subject), data = sleepstudy)
# summary(slmod1)
# summary(slmod2)

set.seed(987654321)
sl_mod2_sims <- simulate(slmod2, nsim = 19) # simulate the fitted linear mixed model
sl_mod2_refit <- lapply(sl_mod2_sims, refit, object = slmod2) # refits the model
sl_mod2_sim_ranef <- lapply(sl_mod2_refit, function(x) ranef(x)[[1]]) # extracts the modes of the random effects
sl_mod2_sim_ranef <- do.call("rbind", sl_mod2_sim_ranef) # binds the 19 different dataframes as one
sl_mod2_sim_ranef$.n <- rownames(sl_mod2_sim_ranef)

sl_mod2_sim_ranef$.n <- as.numeric(str_extract(sl_mod2_sim_ranef$.n, "\\d+")) # assigns numbers for each of 19 simulations
true_sl_mod1_ranef <- ranef(slmod1)$Subject # extracts modes of the correlated effects model

# places the true model among the simulated models to see if correlation between the random effets was necessary
sl_df <- nullabor:::add_true(sl_mod2_sim_ranef, true_sl_mod1_ranef, pos = 9)


ggplot(
  data = sl_df,
  aes(
    x = `(Intercept)`,
    y = Days
  )
) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, alpha = 0.4) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL)
```

Since the true plot is indistinguishable from the null plots, there is no need for the correlation between the random effects.

Hence the model is shown in `slmod2`.

From the true model, replicating the data for 4 times by $y \sim (X\beta, \Omega)$, where $\Omega = Z\Gamma Z^\top + R$ and refitting the model with $y = X\beta + Zb + e$ and get the plots & null plots.

- Version 1: 'best' model
- Version 2: slight noise (error is correlated such as `kronecker(diag(3), matrix(1, nrow = 2, ncol = 2))`, sample from the data by adding small values to the sample data)
- Version 3: Extreme value (with obvious outlier but not that obvious)

Since $M_i$ are the same for each case, the plot 7 and 8 are ignored!

$$\boldsymbol y \sim N(X\beta, Z \Gamma Z^\top + R)$$

```{r fitfn}
# returns a tibble with fitted values along with marginal , conditional residuals as well as std.marginal and conditional residuals
sl_extract_fitted <- function(mod, data) {
  

  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X") # fixed effects model matrix
  beta <- fixef(mod) # fixed effects estimate
  Z <- getME(mod, "Z") # random effects matrix
  u <- c(ranef(mod)$Subject[, 1], ranef(mod)$Subject[, 2]) # extracts the modes of the random effects
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod)) # covariances and correlations of model
  R <- vc$vcov[vc$grp == "Residual"] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[vc$grp == "Subject"] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == "Subject.1"] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2) # covariance matrix of random effects

  Sigma <- Z %*% G %*% t(Z) + R # covariance matrix of marginal distribution of observations

  Sigma_inv <- solve(Sigma) # inverse of sigma

  # variance of marginal residual = sigma-X(X^t * sigma^-1 * X)*X^t
  # variance of conditional residual = R*((sigma^-1)-(sigma^-1)*X*(X^t*sigma^-1*X)^-1*X^t*sigma^-1)*R



  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv # (sigma^-1)-(sigma^-1)*X*(X^t*sigma^-1*X)^-1*X^t*sigma^-1

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) # variance of marginal residual
  varCondRes <- R %*% P %*% R # variance of conditional residual
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G # random effects variance

  # fitted or estimated marginal mean = X*Beta

  fitted_df <- data %>%
    dplyr::mutate(
      fitted = as.vector(X %*% beta),
      resm = y - fitted,
      resc = as.vector(y - fitted - Z %*% u),
      index = 1:n()
    ) %>%
    mutate(
      resm_std = resm / sqrt(diag(varMargRes)[index]), # standardized marginal residual
      resc_std = resc / sqrt(diag(varCondRes)[index]) # standardized conditional residual
    ) %>%
    ungroup()

  return(fitted_df)
}
```

```{r lcrfn}

# returns the least confounded residual

sl_extract_lcr <- function(mod, data) {
 
  
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[, 1], ranef(mod)$Subject[, 2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == "Residual"] * diag(N)
  G1 <- vc$vcov[vc$grp == "Subject"] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == "Subject.1"] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- as.vector(y - fitted - Z %*% u)
  index <- 1:nrow(data)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])


  # standardized least confounded residual = c^T * e / sqrt(CRQRC^t)

  R_half <- expm::sqrtm(R)

  # singer et al calculation for least confounded residual
  auxqn <- eigen((R_half %*% P %*% R_half),
    symmetric = T,
    only.values = FALSE
  )

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N - p)])))) %*% t(auxqn$vectors[1:N, 1:(N - p)]) %*% solve(expm::sqrtm(R[1:N, 1:N]))

  var_resmcp <- lt %*% varCondRes[1:N, 1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N]) / sqrt(diag(var_resmcp))

  resmcp_sl <- tibble::tibble(resmcp)

  return(resmcp_sl)
}
```

```{r simulate}
# simulation of the models
sl_sim <- function(mod, data, nsim = 19, seed, std = FALSE) {
  fit_sim <- simulate(mod, nsim = nsim, seed = seed)
  fit_refit <- lapply(fit_sim, refit, object = mod)
  fit_simy <- lapply(fit_refit, function(x) getME(x, "y"))
  fit_simy_y <- do.call("cbind", fit_simy)
  fit_simy_y <- reshape2::melt(fit_simy_y)[-1]
  names(fit_simy_y) <- c(".n", "y")
  fit_simy_y$.n <- as.numeric(str_extract(fit_simy_y$.n, "\\d+"))
  fit_simy_y$Subject <- rep(data$Subject, 19)
  fit_simy_y$Days <- rep(data$Days, 19)
  return(fit_simy_y)
}
```

```{r residual-extract}
colnames(sleepstudy)[1] <- c("y")
sl_fitted <- sl_extract_fitted(slmod2, sleepstudy)
sl_lcr <- sl_extract_lcr(slmod2, sleepstudy)
```


```{r null-stdres}

# function returns a tibble containing marginal, std marginal , conditonal and std. conditional residuals after 19 simulations
std_res <- function(data) {
  

purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = df)

  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[, 1], ranef(m)$Subject[, 2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == "Residual"] * diag(N)
  G1 <- vc$vcov[vc$grp == "Subject"] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == "Subject.1"] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- y - fitted - as.vector(Z %*% u)
  index <- 1:nrow(df)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])

  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
}
```

```{r null-lcrres}
# function returns least conditional residual after 19 simulations
lcr_res <- function(data) {
  
  purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = df)

  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[, 1], ranef(m)$Subject[, 2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == "Residual"] * diag(N)
  G1 <- vc$vcov[vc$grp == "Subject"] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == "Subject.1"] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- y - fitted - as.vector(Z %*% u)
  index <- 1:nrow(df)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])

  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half),
    symmetric = T,
    only.values = FALSE
  )

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N - p)])))) %*% t(auxqn$vectors[1:N, 1:(N - p)]) %*% solve(expm::sqrtm(R[1:N, 1:N]))

  var_resmcp <- lt %*% varCondRes[1:N, 1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N]) / sqrt(diag(var_resmcp))
  .n <- i

  tibble::tibble(.n, resmcp)
})
  
}
```



```{r best-model-graphics}

ggplot(sl_fitted, aes(index,
  resm_std
)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = sl_fitted %>% filter(resm_std > 2),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

ggplot(sl_fitted, aes(index,
  resc_std
)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )


ggplot(sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

- There is no evidence showing the presence of outlying observations.
- The the index for 8, 57 and 60 are the outlying observations in the reaction values for conditional residuals. 
  + Index 8 shows a significant drop at day 7 for subject 308
  + Index 57 shows an increase at day 6 for subject 332
  + Index 60 shows a drop at day 9 for subject 332
- Plot 6 shows the Gaussian QQ plot for the conditional residuals. However, from the plot, there are obvious tails. One extreme point on the upper end and two on the lower end may seem exceptional. The conditonal residuals might not follow a normal distribution.
- Plot 7 shows the Gaussian QQ plot for the least confounded residuals. There also shows some tails.


## Version 1

```{r}
set.seed(1234)

N <- nrow(sleepstudy)
nsubjects <- length(unique(sleepstudy$Subject))

vc <- as.data.frame(VarCorr(slmod2))
R <- vc$vcov[vc$grp == "Residual"] * diag(N)
G1 <- vc$vcov[vc$grp == "Subject"] * diag(nsubjects)
G2 <- vc$vcov[vc$grp == "Subject.1"] * diag(nsubjects)
G <- Matrix::bdiag(G1, G2)

n <- getME(slmod2, "n")
q <- getME(slmod2, "q")

# normal error
e <- mvrnorm(n = 1, mu = rep(0, n), Sigma = R)

# normal random effects
b <- mvrnorm(n = 1, mu = rep(0, q), Sigma = G)

y <- as.vector(getME(slmod2, "X") %*% fixef(slmod2) + getME(slmod2, "Z") %*% b + e)

v1_sl <- tibble(sleepstudy[, -1], y)
```

```{r v1mod}
v1_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = v1_sl)
```


### Data plots from the 'best' model

```{r v1data}
v1_sl_fitted <- sl_extract_fitted(v1_sl_mod, v1_sl)
v1_sl_lcr <- sl_extract_lcr(v1_sl_mod, v1_sl)
```

```{r}
ggplot(v1_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v1_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
ggplot(v1_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v1_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

ggplot(v1_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(v1_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

- It seems that there is no outlying observations in the marginal residuals
- one or two outlying observations listed in the conditional residual
- The conditional residual and least confounded residuals are not normally distributed as both are right-skewed.

### 1st replication

#### Simulation

```{r}
v11_sl_sim <- sl_sim(v1_sl_mod, v1_sl, seed = 1234)
```

```{r nullfitted-v11}
v11_sl_sim_fitted <- std_res(v11_sl_sim)

```

```{r lcrsimnull-v11}

v11_sl_simlcr <- lcr_res(v11_sl_sim)
```

##### Lineup plots

```{r v11n-plot2}
s11_1 <-
  lineup(true = v1_sl_fitted,
         samples = v11_sl_sim_fitted,
         pos = 7) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v11_1.png",
  plot = s11_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v11n-plot4, fig.height=6}
s11_2 <-
  lineup(true = v1_sl_fitted,
         samples = v11_sl_sim_fitted,
         pos = 7) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v11_2.png",
  plot = s11_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v11n-plot6, fig.height=6}
s11_3 <-
  lineup(true = v1_sl_fitted,
         samples = v11_sl_sim_fitted,
         pos = 9) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v11_3.png",
  plot = s11_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v11n-plot6-lcr, fig.height=6}
s11_4 <-
  lineup(true = v1_sl_lcr,
         samples = v11_sl_simlcr,
         pos = 9) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v11_4.png",
  plot = s11_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### 2nd replication

### Simulation

```{r}
v12_sl_sim <- sl_sim(v1_sl_mod, v1_sl, seed = 2345)
```

```{r nullfitted-v12}
v12_sl_sim_fitted <- std_res(v12_sl_sim)
```

```{r lcrsimnull-v12}
v12_sl_simlcr <- lcr_res(v12_sl_sim)
```

#### Lineup plots

```{r v12n-plo2, fig.height=6}
s12_1 <-
  lineup(true = v1_sl_fitted,
         samples = v12_sl_sim_fitted,
         pos = 7) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v12_1.png",
  plot = s12_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v12n-plo4, fig.height=6}
s12_2 <-
  lineup(true = v1_sl_fitted,
         samples = v12_sl_sim_fitted,
         pos = 7) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v12_2.png",
  plot = s12_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v12n-plo6}
s12_3 <-
  lineup(true = v1_sl_fitted,
         samples = v12_sl_sim_fitted,
         pos = 9) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v12_3.png",
  plot = s12_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v12n-plo6-lcr, fig.height=6}
s12_4 <-
  lineup(true = v1_sl_lcr,
         samples = v12_sl_simlcr,
         pos = 9) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v12_4.png",
  plot = s12_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### 3rd replication

### Simulation

```{r}
v13_sl_sim <- sl_sim(v1_sl_mod, v1_sl, seed = 3456)
```

```{r nullfitted-v13}
v13_sl_sim_fitted <- std_res(v13_sl_sim)
```

```{r lcrsimnull-v13}
v13_sl_simlcr <- lcr_res(v13_sl_sim)
```

#### Lineup plots

```{r v13n-plo2, fig.height=6}
s13_1 <-
  lineup(true = v1_sl_fitted,
         samples = v13_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v13_1.png",
  plot = s13_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v13n-plo4, fig.height=6}
s13_2 <-
  lineup(true = v1_sl_fitted,
         samples = v13_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v13_2.png",
  plot = s13_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v13n-plo6, fig.height=6}
s13_3 <-
  lineup(true = v1_sl_fitted,
         samples = v13_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v13_3.png",
  plot = s13_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


```{r v13n-plo6-lcr, fig.height=6}
s13_4 <-
  lineup(true = v1_sl_lcr,
         samples = v13_sl_simlcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v13_4.png",
  plot = s13_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### 4th replication

### Simulation

```{r}
v14_sl_sim <- sl_sim(v1_sl_mod, v1_sl, seed = 9876)
```

```{r nullfitted-v14}
v14_sl_sim_fitted <- std_res(v14_sl_sim)
```

```{r lcrsimnull-v14}
v14_sl_simlcr <- lcr_res(v14_sl_sim)
```

#### Lineup plots

```{r v14n-plo2, fig.height=6}
s14_1 <-
  lineup(true = v1_sl_fitted,
         samples = v14_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v14_1.png",
  plot = s14_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


```{r v14n-plo4, fig.height=6}
s14_2 <-
  lineup(true = v1_sl_fitted,
         samples = v14_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v14_2.png",
  plot = s14_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r v14n-plo6, fig.height=6}
s14_3 <-
  lineup(true = v1_sl_fitted,
         samples = v14_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v14_3.png",
  plot = s14_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


```{r v14n-plo6-lcr, fig.height=6}
s14_4 <-
  lineup(true = v1_sl_lcr,
         samples = v14_sl_simlcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version1/"),
  filename = "slp_v14_4.png",
  plot = s14_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


## Version 2

Added the within unit correlation in the error term by value 1, that is for first subject, first 10 observations' error terms are correlated.

Or we sampled the day (from 0 to 9) as the index. We added 50 to the reaction value for each subject on the same day which is sampled from. 

```{r slight-noise}


N <- nrow(sleepstudy)
subjects <- unique(sleepstudy$Subject)
nsubjects <- length(subjects)
X <- getME(slmod2, "X")
beta <- fixef(slmod2)
Z <- getME(slmod2, "Z")
u <- c(ranef(slmod2)$Subject[, 1], ranef(slmod2)$Subject[, 2])
q <- length(u)
vc <- as.data.frame(VarCorr(slmod2))
R <- vc$vcov[vc$grp == "Residual"] * diag(N / nsubjects)
G1 <- vc$vcov[vc$grp == "Subject"] * diag(nsubjects)
G2 <- vc$vcov[vc$grp == "Subject.1"] * diag(nsubjects)
G <- Matrix::bdiag(G1, G2)


# correlation in error added
R[lower.tri(R)] <- 25
R[upper.tri(R)] <- 25

R <- kronecker(diag(18), R) # kronecker matrix multiplication

Sigma <- Z %*% G %*% t(Z) + R

set.seed(1234)
y <- as.vector(mvtnorm::rmvnorm(1,
  mean = X %*% beta,
  sigma = Sigma,
  checkSymmetry = FALSE
))

v2_sl <- tibble(
  y, sleepstudy$Days,
  sleepstudy$Subject
)

colnames(v2_sl) <- c("y", "Days", "Subject")

# Second option:
# repc2 <- sleepstudy
# set.seed(1234)
# samp <- sample(1:10, 1)
# colnames(repc2)[1] <- "y"
# mean_subject <- ddply(repc2, .(Subject), summarise, mean = mean(y))
# mean(mean_subject$mean)*0.1
# for (i in 1:n){
#  repc2[(i*samp),]$y <- repc2[(i*samp),]$y + 30
# }

# repc2
```


```{r t-distr}
set.seed(1234)
# multivariate t error term
e <- as.vector(rmvt(1, sigma = R, df = 5))
# normal random effects
b <- mvrnorm(n = 1, mu = rep(0, q), Sigma = G)
y <- as.vector(getME(slmod2, "X") %*% fixef(slmod2) + getME(slmod2, "Z") %*% b + e)

v2_lin <- tibble(sleepstudy[, -1], y)

v2_sl_mod_new <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = v2_lin)
v2_sl_fitted_new <- sl_extract_fitted(v2_sl_mod_new, v2_lin)
v2_sl_lcr_new <- sl_extract_lcr(v2_sl_mod_new, v2_lin)

```

```{r v2-model}

v2_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = v2_sl)

v2_sl_fitted <- sl_extract_fitted(v2_sl_mod, v2_sl)
v2_sl_lcr <- sl_extract_lcr(v2_sl_mod, v2_sl)
```

### Data plots
```{r}
ggplot(v2_sl_fitted, aes(index,
  resm_std
)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v2_sl_fitted %>% filter(abs(resm_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

ggplot(v2_sl_fitted, aes(index,
  resc_std
)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v2_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )


ggplot(v2_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(v2_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

By adding the noise,
- the extra outlying observation of subject 333 is added for marginal
- the extra outlying observation of subject 178 is added for conditional residual
- the conditional residual does not follow a normal distribution as it is right-skewed
- the least confounded residual does not follow a normal distribution as well as it is relative negative-skewed.

### 1st replication

### Simulation

```{r}
v21_sl_sim <- sl_sim(v2_sl_mod, v2_sl, seed = 9876)
v21_sl_sim_new <- sl_sim(v2_sl_mod_new, v2_lin, seed = 9876)

```

```{r nullfitted-v21}

# standardized marginal and conditional residual
v21_sl_sim_fitted <- std_res(v21_sl_sim)
v21_sl_sim_fitted_new <- std_res(v21_sl_sim_new)
```

```{r lcrsimnull-v21}

# least confounded conditional residual
v21_sl_simlcr <- lcr_res(v21_sl_sim)
v21_sl_simlcr_new <- lcr_res(v21_sl_sim_new)
```

#### Lineup plots

```{r v21n-plo2, fig.height=6}

s21_1 <- lineup(
  true = v2_sl_fitted,
  samples = v21_sl_sim_fitted,
  pos = 5
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

s21_1

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"),
  filename = "slp_v21_1.png",
  plot = s21_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

s21_1_new <- lineup(
  true = v2_sl_fitted_new,
  samples = v21_sl_sim_fitted_new,
  pos = 5
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

s21_1_new

```

```{r v21n-plo4, fig.height=6}

s21_2 <- lineup(
  true = v2_sl_fitted,
  samples = v21_sl_sim_fitted,
  pos = 5
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )
s21_2
ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"),
  filename = "slp_v21_2.png",
  plot = s21_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

lineup(
  true = v2_sl_fitted_new,
  samples = v21_sl_sim_fitted_new,
  pos = 5
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )
```

```{r v21n-plo6, fig.height=6}
s21_3 <- lineup(
  true = v2_sl_fitted,
  samples = v21_sl_sim_fitted,
  pos = 8
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample,
    ncol = 5
  ) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )
s21_3


ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"),
  filename = "slp_v21_3.png",
  plot = s21_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

lineup(
  true = v2_sl_fitted_new,
  samples = v21_sl_sim_fitted_new,
  pos = 8
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample,
    ncol = 5
  ) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )
```

```{r v21n-plo6-lcr, fig.height=6}
s21_4 <- lineup(
  true = v2_sl_lcr,
  samples = v21_sl_simlcr,
  pos = 8
) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample,
    ncol = 5
  ) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

s21_4
ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"),
  filename = "slp_v21_4.png",
  plot = s21_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

lineup(
  true = v2_sl_lcr_new,
  samples = v21_sl_simlcr_new,
  pos = 8
) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample,
    ncol = 5
  ) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

```


### 2nd replication

### Simulation

```{r}
v22_sl_sim <- sl_sim(v2_sl_mod, v2_sl, seed = 8765)
```

```{r nullfitted-v22}
v22_sl_sim_fitted <- std_res(v22_sl_sim)
```

```{r lcrsimnull-v22}
v22_sl_simlcr <- lcr_res(v22_sl_sim)
```

#### Lineup plots

```{r v22n-plo2, fig.height=6}

s22_1 <- lineup(
  true = v2_sl_fitted,
  samples = v22_sl_sim_fitted,
  pos = 5
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v22_1.png",
  plot = s22_1, device = "png", dpi = 300,
  height = 12, width = 12
)
```

```{r v22n-plo4, fig.height=6}
s22_2 <- lineup(
  true = v2_sl_fitted,
  samples = v22_sl_sim_fitted,
  pos = 5
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v22_2.png",
  plot = s22_2, device = "png", dpi = 300,
  height = 12, width = 12
)
```

```{r v22n-plo6, fig.height=6}

s22_3 <- lineup(
  true = v2_sl_fitted,
  samples = v22_sl_sim_fitted,
  pos = 8
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none", aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v22_3.png",
  plot = s22_3, device = "png", dpi = 300,
  height = 12, width = 12
)
```

```{r v22n-plo6-lcr, fig.height=6}

s22_4 <- lineup(
  true = v2_sl_lcr,
  samples = v22_sl_simlcr,
  pos = 8
) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none", aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v22_4.png",
  plot = s22_4, device = "png", dpi = 300,
  height = 12, width = 12
)
```

### 3rd replication

#### Simulation

```{r}
v23_sl_sim <- sl_sim(v2_sl_mod, v2_sl, seed = 4387)
```

```{r nullfitted-v23}
v23_sl_sim_fitted <- std_res(v23_sl_sim)
```

```{r lcrsimnull-v23}
v23_sl_simlcr <- lcr_res(v23_sl_sim)
```

##### Lineup plots

```{r v23n-plo2, fig.height=6}

s23_1 <- lineup(
  true = v2_sl_fitted,
  samples = v23_sl_sim_fitted,
  pos = 15
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v23_1.png",
  plot = s23_1, device = "png", dpi = 300,
  height = 12, width = 12
)
```

```{r v23n-plo4, fig.height=6}

s23_2 <- lineup(
  true = v2_sl_fitted,
  samples = v23_sl_sim_fitted,
  pos = 15
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v23_2.png",
  plot = s23_2, device = "png", dpi = 300,
  height = 12, width = 12
)
```

```{r v23n-plo6, fig.height=6}

s23_3 <- lineup(
  true = v2_sl_fitted,
  samples = v23_sl_sim_fitted,
  pos = 20
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v23_3.png",
  plot = s23_3, device = "png", dpi = 300,
  height = 12, width = 12
)
```

```{r v23n-plo6-lcr, fig.height=6}

s23_4 <- lineup(
  true = v2_sl_lcr,
  samples = v23_sl_simlcr,
  pos = 20
) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v23_4.png",
  plot = s23_4, device = "png", dpi = 300,
  height = 12, width = 12
)
```

### 4th replication

#### Simulation

```{r}
v24_sl_sim <- sl_sim(v2_sl_mod, v2_sl, seed = 8696)
```

```{r nullfitted-v24}

v24_sl_sim_fitted <- std_res(v24_sl_sim)
```

```{r lcrsimnull-v24}

v24_sl_simlcr <- lcr_res(v24_sl_sim)
```

##### Lineup plots

```{r v24n-plo2, fig.height=6}

s24_1 <- lineup(
  true = v2_sl_fitted,
  samples = v24_sl_sim_fitted,
  pos = 15
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(), axis.text.x = element_blank(),
    axis.ticks.x = element_blank(), axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v24_1.png",
  plot = s24_1, device = "png", dpi = 300,
  height = 12, width = 12
)
```

```{r v24n-plo4, fig.height=6}

s24_2 <- lineup(
  true = v2_sl_fitted,
  samples = v24_sl_sim_fitted,
  pos = 15
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v24_2.png",
  plot = s24_2, device = "png", dpi = 300,
  height = 12, width = 12
)
```

```{r v24n-plo6, fig.height=6}

s24_3 <- lineup(
  true = v2_sl_fitted,
  samples = v24_sl_sim_fitted,
  pos = 20
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v24_3.png",
  plot = s24_3, device = "png", dpi = 300,
  height = 12, width = 12
)
```


```{r v24n-plo6-lcr, fig.height=6}

s24_4 <- lineup(
  true = v2_sl_lcr,
  samples = v24_sl_simlcr,
  pos = 20
) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version2/"), filename = "slp_v24_4.png",
  plot = s24_4, device = "png", dpi = 300,
  height = 12, width = 12
)
```


## Version 3

I randomly insert 40% of the mean value of response value in `sleepstudy` to two of each subject.

```{r}
set.seed(1234)

# two subjects selected at random and 40% of mean value is added as noise
samp_df <- sleepstudy %>%
  group_by(Subject) %>%
  sample_n(size = 2) %>%
  tibble()

samp_df$y <- samp_df$y + mean(sleepstudy$y) * 0.4

rest_df <- anti_join(sleepstudy,
  samp_df,
  by = c(
    "Days",
    "Subject"
  )
)

d <- rbind(
  samp_df,
  rest_df
)

v3_sl <- d %>% arrange(Subject, Days)
```

```{r}
v3_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = v3_sl)

v3_sl_fitted <- sl_extract_fitted(v3_sl_mod, v3_sl)
v3_sl_lcr <- sl_extract_lcr(v3_sl_mod, v3_sl)
```

#### Data plots

```{r}

ggplot(v3_sl_fitted, aes(index,
  resm_std
)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v3_sl_fitted %>%
      filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

slp_dp2_updated <- ggplot(v3_sl_fitted, aes(index,
  resc_std
)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v3_sl_fitted %>%
      filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  ) +
  ylab("Standardised conditional residuals") +
  theme()



ggsave(
  path = here::here("figures/second/"),
  filename = "slp_dp2_updated.png",
  plot = slp_dp2_updated,
  device = "png", dpi = 300
)

ggplot(
  v3_sl_fitted,
  aes(sample = resc_std)
) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(v3_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

- There is one obvious outliers in the marginal residuals
- There are 3 obvious outliers in the conditional residuals
- Both are not normally distributed.


### 1st replication

#### Simulation
```{r}
v31_sl_sim <- sl_sim(v3_sl_mod, v3_sl, seed = 1253)
```

```{r nullfitted-v31}

v31_sl_sim_fitted <- std_res(v31_sl_sim)

```

```{r lcrsimnull-v31}

v31_sl_simlcr <- lcr_res(v31_sl_sim)

```


##### Lineup plots

```{r v31n-plo2, fig.height=6}

s31_1 <- lineup(
  true = v3_sl_fitted,
  samples = v31_sl_sim_fitted,
  pos = 15
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v31_1_updated.png",
  plot = s31_1, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```

```{r v31n-plo4, fig.height=6}

s31_2 <- lineup(
  true = v3_sl_fitted,
  samples = v31_sl_sim_fitted,
  pos = 15
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v31_2_updated.png",
  plot = s31_2, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```

```{r v31n-plo6, fig.height=6}

s31_3 <- lineup(
  true = v3_sl_fitted,
  samples = v31_sl_sim_fitted,
  pos = 11
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none", aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v31_3_updated.png",
  plot = s31_3, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```

```{r v31n-plo6-lcr, fig.height=6}

s31_4 <- lineup(
  true = v3_sl_lcr,
  samples = v31_sl_simlcr,
  pos = 11
) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v31_4_updated.png",
  plot = s31_4, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```


### 2nd replication

#### Simulation

```{r}
v32_sl_sim <- sl_sim(v3_sl_mod, v3_sl, seed = 2353)
```

```{r nullfitted-v32}
v32_sl_sim_fitted <- std_res(v32_sl_sim)
```

```{r lcrsimnull-v32}
v32_sl_simlcr <- lcr_res(v32_sl_sim)
```

##### Lineup plots

```{r v32n-plo2, fig.height=6}

s32_1 <- lineup(
  true = v3_sl_fitted,
  samples = v32_sl_sim_fitted,
  pos = 15
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v32_1_updated.png",
  plot = s32_1, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```

```{r v32n-plo4, fig.height=6}

s32_2 <- lineup(
  true = v3_sl_fitted,
  samples = v32_sl_sim_fitted,
  pos = 15
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v32_2_updated.png",
  plot = s32_2,
  device = "png", dpi = 300,
  height = 12, width = 12
)
```


```{r v32n-plo6, fig.height=6}

s32_3 <- lineup(
  true = v3_sl_fitted,
  samples = v32_sl_sim_fitted,
  pos = 11
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v32_3_updated.png",
  plot = s32_3,
  device = "png", dpi = 300,
  height = 12, width = 12
)
```


```{r v32n-plo6-lcr, fig.height=6}

s32_4 <- lineup(
  true = v3_sl_lcr,
  samples = v32_sl_simlcr,
  pos = 11
) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v32_4_updated.png",
  plot = s32_4, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```

### 3rd replication

#### Simulation

```{r}
v33_sl_sim <- sl_sim(v3_sl_mod, v3_sl, seed = 4792)
```

```{r nullfitted-v33}

v33_sl_sim_fitted <- std_res(v33_sl_sim)
```

```{r lcrsimnull-v33}

v33_sl_simlcr <- lcr_res(v33_sl_sim)
```

##### Lineup plots

```{r v33n-plo2, fig.height=6}

s33_1 <- lineup(
  true = v3_sl_fitted,
  samples = v33_sl_sim_fitted,
  pos = 2
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v33_1_updated.png",
  plot = s33_1, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```


```{r v33n-plo4, fig.height=6}

s33_2 <- lineup(
  true = v3_sl_fitted,
  samples = v33_sl_sim_fitted,
  pos = 2
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v33_2_updated.png",
  plot = s33_2, device = "png", dpi = 300,
  height = 12,
  width = 12
)
```



```{r v33n-plo6, fig.height=6}

s33_3 <- lineup(
  true = v3_sl_fitted,
  samples = v33_sl_sim_fitted,
  pos = 6
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v33_3_updated.png",
  plot = s33_3, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```

true plot is identified, the conditional residual does not follow a normal distribution.

```{r v33n-plo6-lcr, fig.height=6}

s33_4 <- lineup(
  true = v3_sl_lcr,
  samples = v33_sl_simlcr, pos = 6
) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v33_4_updated.png",
  plot = s33_4, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```


### 4th replication

#### Simulation

```{r}
v34_sl_sim <- sl_sim(v3_sl_mod, v3_sl, seed = 9865)
```

```{r nullfitted-v34}
v34_sl_sim_fitted <- std_res(v34_sl_sim)
```

```{r lcrsimnull-v34}

v34_sl_simlcr <- lcr_res(v34_sl_sim)
```


##### Lineup plots

```{r v34n-plo2, fig.height=6}

s34_1 <- lineup(
  true = v3_sl_fitted,
  samples = v34_sl_sim_fitted,
  pos = 2
) %>%
  ggplot(aes(index,
    resm_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v34_1_updated.png",
  plot = s34_1, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```

```{r v34n-plo4, fig.height=6}
s34_2 <- lineup(
  true = v3_sl_fitted,
  samples = v34_sl_sim_fitted,
  pos = 2
) %>%
  ggplot(aes(index,
    resc_std
  )) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v34_2_updated.png",
  plot = s34_2, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```


```{r v34n-plo6, fig.height=6}

s34_3 <- lineup(
  true = v3_sl_fitted,
  samples = v34_sl_sim_fitted,
  pos = 6
) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v34_3_updated.png",
  plot = s34_3, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```


```{r v34n-plo6-lcr, fig.height=6}

s34_4 <- lineup(
  true = v3_sl_lcr,
  samples = v34_sl_simlcr,
  pos = 6
) %>%

  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/sleep_study/version3/"),
  filename = "slp_v34_4_updated.png",
  plot = s34_4, device = "png",
  dpi = 300,
  height = 12, width = 12
)
```

- For version 3, the conditional residual is easier to be detected.
