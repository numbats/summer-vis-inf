---
title: "case6"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(HLMdiag)
library(lme4)
library(nlme)
library(ggplot2)
library(nullabor)
library(ggforce)
library(dplyr)
library(stringr)
library(mvtnorm)
library(MASS)
```

Autism data has 155 children between the ages of 2 and 13 who were diagnosed with either autism spectrum disorder or non-spectrum developmental delays at age 2.

It contains 604 observations with 7 variables:

- `childid`: Child ID
- `sicdegp`: Sequenced Inventory of Communication Development group (an assessment of expressive language development) with levels low, mod, and high
- `age2`: Age (in years) centered arond age 2 (age at diagnosis)
- `vsae`: Vineland Socialization Age Equivalent
- `gender`: Child's gender, female and male
- `race`: Child's race, white and non-white
- `bestest2`: Diagnosis at age 2, autism and pdd

```{r}
data(autism)
str(autism)
summary(autism)
length(unique(autism$childid))
```


```{r}
names(gsummary(autism, form = ~childid, inv = T))
```

- subject-level variables:
+ `chilidid`
+ `sicdegp`
+ `gender`
+ `race`
+ `bestest2`

```{r}
ggplot(autism, aes(age2, log10(vsae))) +
  geom_point() +
  facet_wrap_paginate(~childid, nrow = 5, ncol = 5, page = 1) +
  geom_smooth(method = "lm", se = F)
```

- `age2` has the relative positive relationship with `vsae`
- It seems to have the similar intercept but with different slopes.

```{r}
ggplot(autism, aes(gender, vsae)) +
  geom_boxplot() +
  scale_y_log10()
```

- By plotting the `gender` versus `vsae`, there is no much difference between male and female with respective to `vsae`.

```{r}
ggplot(autism, aes(interaction(gender, race), vsae)) +
  geom_boxplot() +
  scale_y_log10()
```

- White has higher value in `vsae` than non-white on average
- Female has higher value in `vsae` than male on average

```{r}
ggplot(autism, aes(sicdegp, vsae, fill = race)) +
  geom_boxplot() +
  scale_y_log10()
```

- Positive relationship with `sicdegp` and `vsae` (higher level in `sicdegp` results in higher value in `vsae`)
- `race` for white seems to have higher value in `vsae`.

```{r}
ggplot(autism, aes(bestest2, vsae)) +
  geom_boxplot() +
  scale_y_log10()
```

- pdd seems to have higher value in `vsae` than autism

At this stage, the variables, interaction of `gender` and `race`, `sicdegp`, `age2` and `bestest2` include in the model as matrix of fixed effect. From the `age2` versus `vsae` plot, the intercept seems to be same while the slope is different for each different children. Then we treat the random effect with random slope. As Adam mentioned, the model for LMM needs the quadratic random slope.

```{r model}
colnames(autism)[4] <- c("y")
autism_mod <- lmer(y ~ age2 + sicdegp + gender:race + bestest2 + (age2 - 1 | childid) + (I(age2^2) - 1 | childid), data = autism)


vc <- as.data.frame(VarCorr(autism_mod))
# vc$vcov[vc$grp == "childid.1"]
```

```{r fittedfn}
autism_extract_fitted_mod <- function(mod, data) {
 
 
  # n <- getME(mod, "n")
   N <- nrow(data)


  y <- getME(mod, "y")
  X <- getME(mod, "X")
  beta <- getME(mod, "beta")
  Z <- getME(mod, "Z")
  u <- getME(mod, "b")
  q <- getME(mod, "q")

  nrfacs <- getME(mod,"n_rfacs")
  num <- 0

    if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(mod)))) 
 
 for(i in 1:nrfacs)
 {
  num[i] <- nrow(unique(a[i]))
 }
  vc <- as.data.frame(VarCorr(mod))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(mod))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}


 Sigma <- Z %*% G %*% t(Z) + R
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted_df <- data %>%
    dplyr::mutate(
      fitted = as.vector(X %*% beta),
      resm = y - fitted,
      resc = as.vector(y - fitted - Z %*% u),
      index = 1:n()
    ) %>%
    mutate(
      resm_std = resm / sqrt(diag(varMargRes)[index]),
      resc_std = resc / sqrt(diag(varCondRes)[index])
    ) %>%
    ungroup()
}
```



```{r lcrfn}
autism_extract_lcr_mod <- function(mod, data) {
  

  
  N <- nrow(data)
 y <- getME(mod, "y")
  X <- getME(mod, "X")
  beta <- getME(mod, "beta")
  Z <- getME(mod, "Z")
  u <- getME(mod, "b")
  q <- getME(mod, "q")
  
  nrfacs <- getME(mod,"n_rfacs")
  num <- 0

    if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(mod)))) 
 
 for(i in 1:nrfacs)
 {
  num[i] <- nrow(unique(a[i]))
 }
  vc <- as.data.frame(VarCorr(mod))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(mod))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}

  Sigma <- Z %*% G %*% t(Z) + R

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- as.vector(y - fitted - Z %*% u)
  index <- 1:nrow(data)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])

  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N, 1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N]) / sqrt(diag(var.resmcp))

  resmcp_sl <- tibble::tibble(resmcp)

  return(resmcp_sl)
}
```

```{r simulatefn}
autism_sim <- function(mod, data, nsim = 19, seed, std = FALSE) {
  fit_sim <- simulate(mod, nsim = nsim, seed = seed, std = std)
  fit_refit <- lapply(fit_sim, refit, object = mod)
  fit_simy <- lapply(fit_refit, function(x) getME(x, "y"))
  fit_simy_y <- do.call("cbind", fit_simy)
  fit_simy_y <- reshape2::melt(fit_simy_y)[-1]
  names(fit_simy_y) <- c(".n", "y")
  fit_simy_y$.n <- as.numeric(str_extract(fit_simy_y$.n, "\\d+"))
  fit_simy_y$age2 <- rep(data$age2, 19)
  fit_simy_y$sicdegp <- rep(data$sicdegp, 19)
  fit_simy_y$gender <- rep(data$gender, 19)
  fit_simy_y$race <- rep(data$race, 19)
  fit_simy_y$bestest2 <- rep(data$bestest2, 19)
  fit_simy_y$childid <- rep(data$childid, 19)
  return(fit_simy_y)
}
```


```{r}
std_res <- function(data) {
  purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ age2 + sicdegp + race + bestest2 + (age2 - 1 | childid) + (I(age2^2) - 1 | childid), data = df)
  
  N <- nrow(df)
  y <- getME(m, "y")
  X <- getME(m, "X")
  beta <- getME(m, "beta")
  Z <- getME(m, "Z")
  u <- getME(m, "b")
  q <- getME(m, "q")

 nrfacs <- getME(m,"n_rfacs")
  num <- 0

    if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(m)))) 
 
 for(i in 1:nrfacs)
 {
  num[i] <- nrow(unique(a[i]))
 }
  vc <- as.data.frame(VarCorr(m))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(m))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}


  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)


  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
}
```


```{r}
lcr_res <- function(data) {
  
  purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
 m <- lmer(y ~ age2 + sicdegp + race + bestest2 + (age2 - 1 | childid) + (I(age2^2) - 1 | childid), data = df)

  N <- nrow(df)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  y <- getME(m, "y")
  X <- getME(m, "X")
  beta <- getME(m, "beta")
  Z <- getME(m, "Z")
  u <- getME(m, "b")
  q <- getME(m, "q")

 nrfacs <- getME(m,"n_rfacs")
 num <- 0 

  if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(m)))) 
 
 for(i in 1:nrfacs)
 {
  num[i] <- nrow(unique(a[i]))
 }
  vc <- as.data.frame(VarCorr(m))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(m))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}

  Sigma <- Z %*% G %*% t(Z) + R
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- y - fitted - as.vector(Z %*% u)
  index <- 1:nrow(df)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])

  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half),
    symmetric = T,
    only.values = FALSE
  )

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N - p)])))) %*% t(auxqn$vectors[1:N, 1:(N - p)]) %*% solve(expm::sqrtm(R[1:N, 1:N]))

  var_resmcp <- lt %*% varCondRes[1:N, 1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N]) / sqrt(diag(var_resmcp))
  .n <- i

  tibble::tibble(.n, resmcp)
})
  
}
```


# Data plots

```{r datas}
autism_fitted <- autism_extract_fitted_mod(autism_mod, autism)
autism_lcr <- autism_extract_lcr_mod(autism_mod, autism)
```


```{r}
ggplot(autism_fitted, aes(index, resm_std, color = gender, shape = race)) +
  geom_point() +
  geom_text(
    data = autism_fitted %>%
      filter(resm_std > 5),
    aes(label = index),
    nudge_x = 0.35, nudge_y = 0.35,
    size = 2
  )
ggplot(autism_fitted, aes(index, resc_std, color = gender, shape = race)) +
  geom_point()
ggplot(autism_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")
ggplot(autism_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

- the outlying observations are more allocated in the female with non-white feature
- the conditional residuals do not follow a normal distribution while the least confounded conditional residual does not follow a normal distribution as well.

# *Version 1

Simulate from the true model:

```{r}
set.seed(1234)
vc <- VarCorr(autism_mod)
G <- as.matrix(bdiag(vc))
sig_G <- sqrt(G)
sig_e <- sigma(autism_mod)

n <- getME(autism_mod, "n")
q <- getME(autism_mod, "q")
m <- q / nrow(G)

# normal error
e <- rnorm(n = n, mean = 0, sd = sig_e)

# normal random effects
b <- mvrnorm(n = m, mu = rep(0, 2), Sigma = G)
bvec <- c(b[, 1], b[, 2])

y <- as.vector(getME(autism_mod, "X") %*% fixef(autism_mod) + getME(autism_mod, "Z") %*% bvec + e)

v1_autism <- tibble(autism[, -4], y)
```

```{r}
a_v1_mod <- lmer(y ~ age2 + sicdegp + gender:race + bestest2 + (age2 - 1 | childid) + (I(age2^2) - 1 | childid), data = v1_autism)
```

```{r}
v1_fitted <- autism_extract_fitted_mod(a_v1_mod, v1_autism)
v1_lcr <- autism_extract_lcr_mod(a_v1_mod, v1_autism)
```

# Data plots

```{r}
sl_mr <-
  ggplot(v1_fitted, aes(index, resm_std, color = gender, shape = race)) +
  geom_point(alpha = 0.8) +
  geom_hline(yintercept = 0) +
  xlab("Observation Index") +
  ylab("Stadardised Marginal Residuals") +
  theme()


ggplot(v1_fitted, aes(index, resc_std, color = gender, shape = race)) +
  geom_point() +
  geom_hline(yintercept = 0)
ggplot(v1_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")
ggplot(v1_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line()
```

- From the simulated data set, the conditional residuals fit better in normal distribution than the least confounded residuals. It looks like that has less outlying observations. Although, the observations who is female with non-white still can be treated as outliers on the top in the marginal residuals.

## 1st replication

```{r v11.sim}
autism_v11_sim <- autism_sim(a_v1_mod, v1_autism, seed = 1724)
```

```{r v11n.fitted}
autism_v11n_fitted <- std_res(autism_v11_sim)
```

```{r v11n.lcr}
autism_v11n_lcr <- lcr_res(autism_v11_sim)
```

### Outlying observations

```{r}
lineup(true = v1_fitted,
       samples = autism_v11n_fitted,
       pos = 7) %>%
  ggplot(aes(index, resm_std, color = gender, shape = race)) +
  geom_point() +
  facet_wrap( ~ .sample, ncol = 5) +
  theme(axis.title = element_blank(), axis.text = element_blank())
```

```{r}
a11_1 <-
  lineup(true = v1_fitted,
         samples = autism_v11n_fitted,
         pos = 7) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v11_1.png",
  plot = a11_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


```{r}
a11_2 <-
  lineup(true = v1_fitted,
         samples = autism_v11n_fitted,
         pos = 7) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v11_2.png",
  plot = a11_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a11_3 <-
  lineup(true = v1_fitted,
         samples = autism_v11n_fitted,
         pos = 9) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v11_3.png",
  plot = a11_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a11_4 <-
  lineup(true = v1_lcr,
         samples = autism_v11n_lcr,
         pos = 9) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v11_4.png",
  plot = a11_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 2nd replication

```{r v12.sim}
autism_v12_sim <- autism_sim(a_v1_mod, v1_autism, seed = 7620)
```

```{r v12n.fitted}
autism_v12n_fitted <- std_res(autism_v12_sim)
```

```{r v12n.lcr}
autism_v12n_lcr <- lcr_res(autism_v12_sim)
```

### Outlying observations

```{r}
a12_1 <-
  lineup(true = v1_fitted,
         samples = autism_v12n_fitted,
         pos = 7) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v12_1.png",
  plot = a12_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a12_2 <-
  lineup(true = v1_fitted,
         samples = autism_v12n_fitted,
         pos = 7) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v12_2.png",
  plot = a12_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a12_3 <-
  lineup(true = v1_fitted,
         samples = autism_v12n_fitted,
         pos = 9) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
   path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v12_3.png",
  plot = a12_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a12_4 <-
  lineup(true = v1_lcr,
         samples = autism_v12n_lcr,
         pos = 9) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v12_4.png",
  plot = a12_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 3rd replication

```{r v13.sim}
autism_v13_sim <- autism_sim(a_v1_mod, v1_autism, seed = 2746)
```

```{r v13n_fitted}
autism_v13n_fitted <- std_res(autism_v13_sim)
```

```{r v13n.lcr}
autism_v13n_lcr <- lcr_res(autism_v13_sim)
```

### Outlying observations

```{r}
a13_1 <-
  lineup(true = v1_fitted,
         samples = autism_v13n_fitted,
         pos = 13) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v13_1.png",
  plot = a13_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a13_2 <-
  lineup(true = v1_fitted,
         samples = autism_v13n_fitted,
         pos = 13) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v13_2.png",
  plot = a13_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a13_3 <-
  lineup(true = v1_fitted,
         samples = autism_v13n_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v13_3.png",
  plot = a13_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a13_4 <-
  lineup(true = v1_lcr,
         samples = autism_v13n_lcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v13_4.png",
  plot = a13_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```


## 4th replication

```{r v14.sim}
autism_v14_sim <- autism_sim(a_v1_mod, v1_autism, seed = 8502)
```

```{r v14n_fitted}
autism_v14n_fitted <- std_res(autism_v14_sim)
```

```{r v13n.lcr}
autism_v14n_lcr <- lcr_res(autism_v14_sim)
```

### Outlying observations

```{r}
a14_1 <-
  lineup(true = v1_fitted,
         samples = autism_v14n_fitted,
         pos = 13) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v14_1.png",
  plot = a14_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a14_2 <-
  lineup(true = v1_fitted,
         samples = autism_v14n_fitted,
         pos = 13) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v14_2.png",
  plot = a14_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a14_3 <-
  lineup(true = v1_fitted,
         samples = autism_v14n_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v14_3.png",
  plot = a14_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a14_4 <-
  lineup(true = v1_lcr,
         samples = autism_v14n_lcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version1/"),
  filename = "aut_v14_4.png",
  plot = a14_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

# *Version 2

We added the error term as student t distributed.

```{r}
set.seed(5692)
## t distribution
e <- rt(n = n, ncp = sig_e, df = 15)
y <- as.vector(getME(autism_mod, "X") %*% fixef(autism_mod) + getME(autism_mod, "Z") %*% bvec + e)

autism_repc2 <- tibble(autism[, -4], y)
a_v2_mod <- lmer(y ~ age2 + sicdegp + race + bestest2 + (age2 - 1 | childid) + (I(age2^2) - 1 | childid), data = autism_repc2)
```

```{r}
a_v2_fitted <- autism_extract_fitted_mod(a_v2_mod, autism_repc2)
a_v2_lcr <- autism_extract_lcr_mod(a_v2_mod, autism_repc2)
```

# Data plots

```{r}
ggplot(a_v2_fitted, aes(index, resm_std, color = gender, shape = race)) +
  geom_point()
ggplot(a_v2_fitted, aes(index, resc_std, color = gender, shape = race)) +
  geom_point()
ggplot(a_v2_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")
ggplot(a_v2_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

- The outlying observations can be detected as the non-white female in the marginal residuals but more with non-white males are detected in the conditional residuals
- Both conditional residual and least confounded residual are less normally distributed compared with version 1.

## 1st replication

```{r v21.sim}
autism_v21_sim <- autism_sim(a_v2_mod, autism_repc2, seed = 1234)
```

```{r v21n.fitted}
autism_v21n_fitted <- std_res(autism_v21_sim)
```

```{r v21n.lcr}
autism_v21n_lcr <- lcr_res(autism_v21_sim)
```

### Outlying observations

```{r}
a21_1 <-
  lineup(true = a_v2_fitted,
         samples = autism_v21n_fitted,
         pos = 5) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v21_1.png",
  plot = a21_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a21_2 <-
  lineup(true = a_v2_fitted,
         samples = autism_v21n_fitted,
         pos = 5) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v21_2.png",
  plot = a21_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a21_3 <-
  lineup(true = a_v2_fitted,
         samples = autism_v21n_fitted,
         pos = 8) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v21_3.png",
  plot = a21_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a21_4 <-
  lineup(true = a_v2_lcr,
         samples = autism_v21n_lcr,
         pos = 8) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v21_4_png",
  plot = a21_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 2st replication

```{r v22.sim}
autism_v22_sim <- autism_sim(a_v2_mod, autism_repc2, seed = 7620)
```

```{r v22n_fitted}
autism_v22n_fitted <- std_res(autism_v22_sim)
```

```{r v22n.lcr}
autism_v22n_lcr <- lcr_res(autism_v22_sim)
  
```

### Outlying observations

```{r}
a22_1 <-
  lineup(true = a_v2_fitted,
         samples = autism_v22n_fitted,
         pos = 5) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v22_1.png",
  plot = a22_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a22_2 <-
  lineup(true = a_v2_fitted,
         samples = autism_v22n_fitted,
         pos = 5) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v22_2.png",
  plot = a22_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a22_3 <-
  lineup(true = a_v2_fitted,
         samples = autism_v22n_fitted,
         pos = 8) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v22_3.png",
  plot = a22_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a22_4 <-
  lineup(true = a_v2_lcr,
         samples = autism_v22n_lcr,
         pos = 8) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v22_4.png",
  plot = a22_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 3rd replication

```{r v23.sim}
autism_v23_sim <- autism_sim(a_v2_mod, autism_repc2, seed = 4739)
```

```{r v23n_fitted}
autism_v23n_fitted <- std_res(autism_v23_sim)
```

```{r v22n.lcr}
autism_v23n_lcr <- lcr_res(autism_v23_sim)
  
```

### Outlying observations

```{r}
a23_1 <-
  lineup(true = a_v2_fitted,
         samples = autism_v23n_fitted,
         pos = 15) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v23_1.png",
  plot = a23_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a23_2 <-
  lineup(true = a_v2_fitted,
         samples = autism_v23n_fitted,
         pos = 15) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v23_2.png",
  plot = a23_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a23_3 <-
  lineup(true = a_v2_fitted,
         samples = autism_v23n_fitted,
         pos = 20) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v23_3.png",
  plot = a23_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a23_4 <-
  lineup(true = a_v2_lcr,
         samples = autism_v23n_lcr,
         pos = 20) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v23_4.png",
  plot = a23_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 4th replication

```{r v24.sim}
autism_v24_sim <- autism_sim(a_v2_mod, autism_repc2, seed = 8502)
```

```{r v24n_fitted}
autism_v24n_fitted <- std_res(autism_v24_sim)
```

```{r v24n.lcr}
autism_v24n_lcr <- lcr_res(autism_v24_sim)
```

### Outlying observations

```{r}
a24_1 <-
  lineup(true = a_v2_fitted,
         samples = autism_v24n_fitted,
         pos = 15) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v24_1.png",
  plot = a24_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a24_2 <-
  lineup(true = a_v2_fitted,
         samples = autism_v24n_fitted,
         pos = 15) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v24_2.png",
  plot = a24_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a24_3 <-
  lineup(true = a_v2_fitted,
         samples = autism_v24n_fitted,
         pos = 20) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v24_3.png",
  plot = a24_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a24_4 <-
  lineup(true = a_v2_lcr,
         samples = autism_v24n_lcr,
         pos = 20) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version2/"),
  filename = "aut_v24_4.png",
  plot = a24_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

- The data plot of least confounded residual is hard to be identified.

# *Version 3

```{r}
autism %>%
  group_by(childid) %>%
  summarise(mean = mean(y))

mean(autism$y)
```

```{r}
set.seed(2639)
ind <- sample(604, 120, replace = F)
autism_repc3 <- autism
autism_repc3[ind, ]$y <- autism_repc3[ind, ]$y + median(autism_repc3$y) * 0.2
```

```{r}
a_v3_mod <- lmer(y ~ age2 + sicdegp + race + bestest2 + (age2 - 1 | childid) + (I(age2^2) - 1 | childid), data = autism_repc3)
```

```{r}
a_v3_fitted <- autism_extract_fitted_mod(a_v3_mod, autism_repc3)
a_v3_lcr <- autism_extract_lcr_mod(a_v3_mod, autism_repc3)
```

# Data plots

```{r}
ggplot(a_v3_fitted, aes(index, resm_std, color = gender, shape = race)) +
  geom_point()

aut_dp2 <- ggplot(a_v3_fitted, aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  ylab("Standardised conditional residuals") +
  theme()


ggplot(a_v3_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(a_v3_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

- With version 3, there are more outliers on the both marginal residual and conditional residuals_ While, conditional residual may works better on detecting the outlying observations.
- Both conditional residual and least confounded residual are not normally distributed as the tails on both side for conditional residual and the tails on the bottom for least confounded residual.

## 1st replication

```{r}
autism_v31_sim <- autism_sim(a_v3_mod, autism_repc3, seed = 1234)
```

```{r v31n_fitted}
autism_v31n_fitted <-std_res(autism_v31_sim)
```

```{r v31n.lcr}
autism_v31n_lcr <- lcr_res(autism_v31_sim)
```

### Outlying observations

```{r}
a31_1 <-
  lineup(true = a_v3_fitted,
         samples = autism_v31n_fitted,
         pos = 15) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v31_1.png",
  plot = a31_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a31_2 <-
  lineup(true = a_v3_fitted,
         samples = autism_v31n_fitted,
         pos = 15) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v31_2.png",
  plot = a31_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

- Outlying observations can be detected on both conditional and marginal residuals

### Normality checking

```{r}
a31_3 <-
  lineup(true = a_v3_fitted,
         samples = autism_v31n_fitted,
         pos = 11) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v31_3.png",
  plot = a31_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

- The data plot can be identified immediately.

```{r}
a31_4 <-
  lineup(true = a_v3_lcr,
         samples = autism_v31n_lcr,
         pos = 11) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v31_4.png",
  plot = a31_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

- The least confounded residual for the data plot can be detected as well as the outlier on the lower bottom.

## 2nd replication

```{r}
autism_v32_sim <- autism_sim(a_v3_mod, autism_repc3, seed = 7620)
```

```{r v32n_fitted}
autism_v32n_fitted <- std_res(autism_v32_sim)
```

```{r v32n_lcr}
autism_v32n_lcr <- lcr_res(autism_v32_sim)
```

### Outlying observations

```{r}
a32_1 <-
  lineup(true = a_v3_fitted,
         samples = autism_v32n_fitted,
         pos = 15) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v32_1.png",
  plot = a32_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a32_2 <-
  lineup(true = a_v3_fitted,
         samples = autism_v32n_fitted,
         pos = 15) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v32_2.png",
  plot = a32_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a32_3 <-
  lineup(true = a_v3_fitted,
         samples = autism_v32n_fitted,
         pos = 11) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v32_3.png",
  plot = a32_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a32_4 <-
  lineup(true = a_v3_lcr,
         samples = autism_v32n_lcr,
         pos = 11) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v32_4_png",
  plot = a32_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 3rd replication

```{r}
autism_v33_sim <- autism_sim(a_v3_mod, autism_repc3, seed = 4739)
```

```{r v33n_fitted}
autism_v33n_fitted <- std_res(autism_v33_sim)
```

```{r v33n.lcr}
autism_v33n_lcr <- lcr_res(autism_v33_sim)
```

### Outlying observations

```{r}
a33_1 <-
  lineup(true = a_v3_fitted,
         samples = autism_v33n_fitted,
         pos = 2) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v33_1.png",
  plot = a33_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a33_2 <-
  lineup(true = a_v3_fitted,
         samples = autism_v33n_fitted,
         pos = 2) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v33_2.png",
  plot = a33_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a33_3 <-
  lineup(true = a_v3_fitted,
         samples = autism_v33n_fitted,
         pos = 6) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v33_3.png",
  plot = a33_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a33_4 <-
  lineup(true = a_v3_lcr,
         samples = autism_v33n_lcr,
         pos = 6) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v33_4.png",
  plot = a33_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

## 4th replication

```{r}
autism_v34_sim <- autism_sim(a_v3_mod, autism_repc3, seed = 8502)
```

```{r v34n_fitted}
autism_v34n_fitted <- std_res(autism_v34_sim)
```

```{r v34n.lcr}
autism_v34n_lcr <- lcr_res(autism_v34_sim)
```

### Outlying observations

```{r}
a34_1 <-
  lineup(true = a_v3_fitted,
         samples = autism_v34n_fitted,
         pos = 2) %>%
  ggplot(aes(interaction(gender, race), resm_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v34_1.png",
  plot = a34_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a34_2 <-
  lineup(true = a_v3_fitted,
         samples = autism_v34n_fitted,
         pos = 2) %>%
  ggplot(aes(interaction(gender, race), resc_std)) +
  geom_boxplot() +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank()
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v34_2.png",
  plot = a34_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

### Normality checking

```{r}
a34_3 <-
  lineup(true = a_v3_fitted,
         samples = autism_v34n_fitted,
         pos = 6) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v34_3.png",
  plot = a34_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```

```{r}
a34_4 <-
  lineup(true = a_v3_lcr,
         samples = autism_v34n_lcr,
         pos = 6) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  ylab(NULL) +
  xlab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ggsave(
  path = here::here("figures/lineup/autism/version3/"),
  filename = "aut_v34_4.png",
  plot = a34_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
```
