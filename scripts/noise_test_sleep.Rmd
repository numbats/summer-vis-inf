---
title: "case5 noise test"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(mvtnorm)
library(dplyr)
library(tidyverse)
library(plyr)
library(nullabor)
library(MASS)
library(nlme)
library(plotrix)
library(patchwork)
```

18 subjects. 10 days. Day 0 normal sleep. Rest of nights 3 hours of sleep. Reaction variable records average reaction time (ms) per day. 

## Objectives of the residual diagnostics in this thesis 

> checking presence of outlying observations based on marginal residuals as well as conditional residuals, and 

> detecting normality of conditional error according to conditional residuals and confounded residuals.

```{r data}
# Data and its summary
data("sleepstudy")
summary(sleepstudy)
head(sleepstudy)
skimr::skim(sleepstudy)
```
## Actual plot

```{r}
sleepstudy %>%
  ggplot(aes(x=Days,y=Reaction,color=Subject))+
 #geom_point()+
  geom_smooth(method = "lm", se = FALSE)

ggplot(sleepstudy, aes(Days, Reaction)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)

ggplot(sleepstudy, aes(Subject, Reaction)) +
  geom_boxplot()

```



## checking if random effects need to be correlated or independent 

```{r random-intercept}

# random intercept and random slope
slmod1 <- lmer(Reaction ~ Days + (Days | Subject), data = sleepstudy)

# independent random effects
slmod2 <- lmer(Reaction ~ Days + (Days - 1 | Subject) +
  (1 | Subject), data = sleepstudy)
# summary(slmod1)
# summary(slmod2)

set.seed(987654321)
sl_mod2_sims <- simulate(slmod2, nsim = 19) # simulate the fitted linear mixed model
sl_mod2_refit <- lapply(sl_mod2_sims, refit, object = slmod2) # refits the model
sl_mod2_sim_ranef <- lapply(sl_mod2_refit, function(x) ranef(x)[[1]]) # extracts the modes of the random effects
sl_mod2_sim_ranef <- do.call("rbind", sl_mod2_sim_ranef) # binds the 19 different dataframes as one
sl_mod2_sim_ranef$.n <- rownames(sl_mod2_sim_ranef)

sl_mod2_sim_ranef$.n <- as.numeric(str_extract(sl_mod2_sim_ranef$.n, "\\d+")) # assigns numbers for each of 19 simulations
true_sl_mod1_ranef <- ranef(slmod1)$Subject # extracts modes of the correlated effects model

# places the true model among the simulated models to see if correlation between the random effets was necessary
sl_df <- nullabor:::add_true(sl_mod2_sim_ranef, true_sl_mod1_ranef, pos = 9)


ggplot(
  data = sl_df,
  aes(
    x = `(Intercept)`,
    y = Days
  )
) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, alpha = 0.4) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL)
```

The correlated model plot is not distinguishable from the independent random effects plot. There fore we could say that random effects could be independent. 

```{r fitfn}
# returns a tibble with fitted values along with marginal , conditional residuals as well as std.marginal and conditional residuals
sl_extract_fitted <- function(mod, data) {
  
  N <- nrow(data)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()
  
 # subjects <- unique(data$Subject)
  #nsubjects <- length(subjects)

  #y <- data$y
  #X <- getME(mod, "X") # fixed effects model matrix
  #beta <- fixef(mod) # fixed effects estimate
  #Z <- getME(mod, "Z") # random effects matrix
  #u <- c(ranef(mod)$Subject[, 1], ranef(mod)$Subject[, 2]) # extracts the modes of the random effects
  #q <- length(u)
  
  y <- getME(mod, "y")
  X <- getME(mod, "X")
  beta <- getME(mod, "beta")
  Z <- getME(mod, "Z")
  u <- getME(mod, "b")
  q <- getME(mod, "q")
  
  nrfacs <- getME(mod,"n_rfacs")
  num <- 0

    if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(mod)))) 
 
 for(i in 1:nrfacs)
 {
  num[i] <- nrow(unique(a[i]))
 }
  vc <- as.data.frame(VarCorr(mod))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])# covariance matrix of random effects

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(mod))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}
  

  Sigma <- Z %*% G %*% t(Z) + R # covariance matrix of marginal distribution of observations

  Sigma_inv <- solve(Sigma) # inverse of sigma

  # variance of marginal residual = sigma-X(X^t * sigma^-1 * X)*X^t
  # variance of conditional residual = R*((sigma^-1)-(sigma^-1)*X*(X^t*sigma^-1*X)^-1*X^t*sigma^-1)*R



  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv # (sigma^-1)-(sigma^-1)*X*(X^t*sigma^-1*X)^-1*X^t*sigma^-1

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) # variance of marginal residual
  varCondRes <- R %*% P %*% R # variance of conditional residual
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G # random effects variance

  # fitted or estimated marginal mean = X*Beta

  fitted_df <- data %>%
    dplyr::mutate(
      fitted = as.vector(X %*% beta),
      resm = y - fitted,
      resc = as.vector(y - fitted - Z %*% u),
      index = 1:n()
    ) %>%
    mutate(
      resm_std = resm / sqrt(diag(varMargRes)[index]), # standardized marginal residual
      resc_std = resc / sqrt(diag(varCondRes)[index]) # standardized conditional residual
    ) %>%
    ungroup()

  return(fitted_df)
}
```

```{r lcrfn}

# returns the least confounded residual

sl_extract_lcr <- function(mod, data) {

  #n <- getME(mod, "n")
  N <- nrow(data)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()

 # y <- data$y
  #X <- getME(mod, "X")
  #beta <- fixef(mod)
  #Z <- getME(mod, "Z")
  #u <- c(ranef(mod)$Subject[, 1], ranef(mod)$Subject[, 2])
  #q <- length(u)
  
  
  y <- getME(mod, "y")
  X <- getME(mod, "X")
  beta <- getME(mod, "beta")
  Z <- getME(mod, "Z")
  u <- getME(mod, "b")
  q <- getME(mod, "q")
  
  nrfacs <- getME(mod,"n_rfacs")
  num <- 0

  if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(mod)))) 
 
 for(i in 1:nrfacs)
 {
  num[i] <- nrow(unique(a[i]))
 }
  vc <- as.data.frame(VarCorr(mod))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(mod))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}
  Sigma <- Z %*% G %*% t(Z) + R

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- as.vector(y - fitted - Z %*% u)
  index <- 1:nrow(data)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])


  # standardized least confounded residual = c^T * e / sqrt(CRQRC^t)

  R_half <- expm::sqrtm(R)

  # singer et al calculation for least confounded residual
  auxqn <- eigen((R_half %*% P %*% R_half),
    symmetric = T,
    only.values = FALSE
  )

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N - p)])))) %*% t(auxqn$vectors[1:N, 1:(N - p)]) %*% solve(expm::sqrtm(R[1:N, 1:N]))

  var_resmcp <- lt %*% varCondRes[1:N, 1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N]) / sqrt(diag(var_resmcp))

  resmcp_sl <- tibble::tibble(resmcp)

  return(resmcp_sl)
}
```

```{r simulate}
# simulation of the models
sl_sim <- function(mod, data, nsim = 19, seed, std = FALSE) {
  fit_sim <- simulate(mod, nsim = nsim, seed = seed)
  fit_refit <- lapply(fit_sim, refit, object = mod)
  fit_simy <- lapply(fit_refit, function(x) getME(x, "y"))
  fit_simy_y <- do.call("cbind", fit_simy)
  fit_simy_y <- reshape2::melt(fit_simy_y)[-1]
  names(fit_simy_y) <- c(".n", "y")
  fit_simy_y$.n <- as.numeric(str_extract(fit_simy_y$.n, "\\d+"))
  fit_simy_y$Subject <- rep(data$Subject, 19)
  fit_simy_y$Days <- rep(data$Days, 19)
  return(fit_simy_y)
}
```

```{r residual-extract}
colnames(sleepstudy)[1] <- c("y")
sl_fitted <- sl_extract_fitted(slmod2, sleepstudy)
sl_lcr <- sl_extract_lcr(slmod2, sleepstudy)
```


```{r null-stdres}

# function returns a tibble containing marginal, std marginal , conditonal and std. conditional residuals after 19 simulations
std_res <- function(data) {
  


purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = df)

  N <- nrow(df)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  y <- getME(m, "y")
  X <- getME(m, "X")
  beta <- getME(m, "beta")
  Z <- getME(m, "Z")
  u <- getME(m, "b")
  q <- getME(m, "q")

 nrfacs <- getME(m,"n_rfacs")
  num <- 0

  if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(m)))) 
 
 for(i in 1:nrfacs)
 {
  num[i] <- nrow(unique(a[i]))
 }
  vc <- as.data.frame(VarCorr(m))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(m))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}
  
  Sigma <- Z %*% G %*% t(Z) + R
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- y - fitted - as.vector(Z %*% u)
  index <- 1:nrow(df)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])

  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
}
```

```{r null-lcrres}
# function returns least conditional residual after 19 simulations
lcr_res <- function(data) {
  
  purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = df)

  N <- nrow(df)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  y <- getME(m, "y")
  X <- getME(m, "X")
  beta <- getME(m, "beta")
  Z <- getME(m, "Z")
  u <- getME(m, "b")
  q <- getME(m, "q")

 nrfacs <- getME(m,"n_rfacs")
 num <- 0 

  if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(m)))) 
 
 for(i in 1:nrfacs)
 {
  num[i] <- nrow(unique(a[i]))
 }
  vc <- as.data.frame(VarCorr(m))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(m))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}

  Sigma <- Z %*% G %*% t(Z) + R
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- y - fitted - as.vector(Z %*% u)
  index <- 1:nrow(df)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])

  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half),
    symmetric = T,
    only.values = FALSE
  )

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N - p)])))) %*% t(auxqn$vectors[1:N, 1:(N - p)]) %*% solve(expm::sqrtm(R[1:N, 1:N]))

  var_resmcp <- lt %*% varCondRes[1:N, 1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N]) / sqrt(diag(var_resmcp))
  .n <- i

  tibble::tibble(.n, resmcp)
})
  
}
```





```{r}
set.seed(1234)

colnames(sleepstudy)[1] <- c("y")
sample <- tibble(Subject=sample(sleepstudy$Subject,2))
test <- sleepstudy %>%
  dplyr::filter(Subject %in% sample$Subject)


test$y <- test$y + mean(sleepstudy$y) * 0.2

rest_test <- anti_join(sleepstudy,
  test,
  by = c(
    "Days",
    "Subject"
  )
)

dtest <- rbind(
  test,
  rest_test
)


summary(sleepstudy)
summary(dtest)

```
```{r}


ggplot(sleepstudy, aes(Days, y)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)

ggplot(dtest, aes(Days, y)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)

```


# number of days taken from each subject varied

```{r function}

sub_data<- function(sub){
set.seed(2000)


samp <- sleepstudy %>%
  group_by(Subject) %>%
  sample_n(size = sub) %>%
  tibble()

samp$y <- samp$y + mean(sleepstudy$y) * 0.2

rest3 <- anti_join(sleepstudy,
  samp,
  by = c(
    "Days",
    "Subject"
  )
)

n3 <- rbind(
  samp,
  rest3
)

return(n3)

}
```

```{r}
pointlm<- function(data){
  ggplot(data, aes(Days, y)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE) +
  ylim(150,600)
  
}


```

```{r}
zerobox <- ggplot(sleepstudy, aes(Subject, y)) +
  geom_boxplot()+
  ggtitle("zero noise")+
  ylim(150,600)

zeropoint <- ggplot(sleepstudy, aes(Days, y)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)+
  ggtitle("zero noise")+
  ylim(150,600)

box <- function(data){
  ggplot(data, aes(Subject, y)) +
  geom_boxplot()+
  ylim(150,600)
  }


```


```{r}
two <- sub_data(2)
four <- sub_data(4)
six <- sub_data(6)

```


```{r}

twopoint <- pointlm(two) +
  ggtitle("two subjects")

fourpoint <- pointlm(four)+
  ggtitle("4 subjects")
sixpoint <- pointlm(six)+
  ggtitle("6 subjects")

twobox <- box(two)+
  ggtitle("two subjects")
fourbox <- box(four)+
  ggtitle("4 subjects")
sixbox <- box(six)+
  ggtitle("6 subjects")

zeropoint+twopoint+fourpoint+sixpoint

zerobox+twobox+fourbox+sixbox

```



## changing noise strength

```{r function}

new_data<- function(noise){
set.seed(2000)


samp <- sleepstudy %>%
  group_by(Subject) %>%
  sample_n(size = 2) %>%
  tibble()

samp$y <- samp$y + mean(sleepstudy$y) * noise

rest3 <- anti_join(sleepstudy,
  samp,
  by = c(
    "Days",
    "Subject"
  )
)

n3 <- rbind(
  samp,
  rest3
)

return(n3)

}
```

```{r}
twenty <- new_data(0.2)
tfive <- new_data(0.25)
thirty <- new_data(0.3)
thirtyf<- new_data(0.35)

five <- new_data(0.05)
ten <- new_data(0.1)
ften <- new_data(0.15)


```

```{r}

twentypoint <- pointlm(twenty) +
  ggtitle("20%")
tfivepoint <- pointlm(tfive)+
  ggtitle("25%")
thirtypoint <- pointlm(thirty)+
  ggtitle("30%")
thirtyfpoint<- pointlm(thirtyf)+
  ggtitle("35%")


fivepoint <- pointlm(five)+
  ggtitle("5%")
tenpoint <- pointlm(ten)+
  ggtitle("10%")
ftenpoint<- pointlm(ften)+
  ggtitle("15%")


twentybox <- box(twenty) +
  ggtitle("20%")
tfivebox <- box(tfive)+
  ggtitle("25%")
thirtybox <- box(thirty)+
  ggtitle("30%")
thirtyfbox<- box(thirtyf)+
  ggtitle("35%")

zeropoint+twentypoint + tfivepoint + thirtypoint + thirtyfpoint 
zerobox+twentybox + tfivebox + thirtybox + thirtyfbox



```

```{r}
summary(sleepstudy)
summary(twenty)
summary(two)
```

```{r}
summary(sleepstudy)
summary(tfive)
summary(four)

```

Changing the strength of the mean value inserted to random 2 days of each subject is likely to give more outlying observations than increasing the number of days contaminated with 20% mean value for each subject. 


```{r}
summary(sleepstudy)
summary(thirty)
summary(six)

```

```{r}
m0 <- ggplot(sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co0 <- ggplot(sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq0 <- ggplot(sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr0 <- ggplot(sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```


# 5% noise

```{r}
five_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = five)
```


### Data plots 

```{r}
five_sl_fitted <- sl_extract_fitted(five_sl_mod, five)
five_sl_lcr <- sl_extract_lcr(five_sl_mod, five)
```

```{r}
m01 <- ggplot(five_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = five_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co01 <- ggplot(five_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = five_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq01 <- ggplot(five_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr01 <- ggplot(five_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```


## 10%


```{r}
ten_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = ten)
```


### Data plots 

```{r}
ten_sl_fitted <- sl_extract_fitted(ten_sl_mod, ten)
ten_sl_lcr <- sl_extract_lcr(ten_sl_mod, ten)
```

```{r}
m02 <- ggplot(ten_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = ten_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co02 <- ggplot(ten_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = ten_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq02 <- ggplot(ten_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr02 <- ggplot(ten_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

# 15 %


```{r}
ften_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = ften)
```


### Data plots 

```{r}
ften_sl_fitted <- sl_extract_fitted(ften_sl_mod, ften)
ften_sl_lcr <- sl_extract_lcr(ften_sl_mod, ften)
```

```{r}
m03 <- ggplot(ften_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = ften_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co03 <- ggplot(ften_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = ften_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq03 <- ggplot(ften_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr03 <- ggplot(ften_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```




# 20 %


```{r}
twenty_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = twenty)
twenty_sl_sim <- sl_sim(twenty_sl_mod, six, seed = 2345)
twenty_sl_fitted <- sl_extract_fitted(twenty_sl_mod, twenty)
twenty_sl_lcr <- sl_extract_lcr(twenty_sl_mod, twenty)

twenty_sl_sim_fitted <- std_res(twenty_sl_sim)
twenty_sl_simlcr <- lcr_res(twenty_sl_sim)
```



```{r}
m1 <- ggplot(twenty_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = twenty_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co1 <- ggplot(twenty_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = twenty_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq1 <- ggplot(twenty_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr1 <- ggplot(twenty_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

#### Lineup plots

```{r twenty3n-plo2, fig.height=6}
twenty_1 <-
  lineup(true = twenty_sl_fitted,
         samples = twenty_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r twenty3n-plo4, fig.height=6}
twenty_2 <-
  lineup(true = twenty_sl_fitted,
         samples = twenty_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r twenty3n-plo6, fig.height=6}
twenty_3 <-
  lineup(true = twenty_sl_fitted,
         samples = twenty_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

```


```{r twenty3n-plo6-lcr, fig.height=6}
twenty_4 <-
  lineup(true = twenty_sl_lcr,
         samples = twenty_sl_simlcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

twenty_1
twenty_2
twenty_3
twenty_4

```
##tfive data plot 

```{r}
tfive_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = tfive)
```


### Data plots 

```{r}
tfive_sl_fitted <- sl_extract_fitted(tfive_sl_mod, tfive)
tfive_sl_lcr <- sl_extract_lcr(tfive_sl_mod, tfive)
```

```{r}
m2 <- ggplot(tfive_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = tfive_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co2 <- ggplot(tfive_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = tfive_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq2 <- ggplot(tfive_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr2 <- ggplot(tfive_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

##thirty data plot 

```{r}
thirty_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = thirty)
```


### Data plots 

```{r}
thirty_sl_fitted <- sl_extract_fitted(thirty_sl_mod, thirty)
thirty_sl_lcr <- sl_extract_lcr(thirty_sl_mod, thirty)
```

```{r}
m3 <- ggplot(thirty_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = thirty_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co3 <- ggplot(thirty_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = thirty_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq3 <- ggplot(thirty_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr3 <- ggplot(thirty_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

##thirtyf data plot 

```{r}
thirtyf_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = thirtyf)
```


### Data plots 

```{r}
thirtyf_sl_fitted <- sl_extract_fitted(thirtyf_sl_mod, thirtyf)
thirtyf_sl_lcr <- sl_extract_lcr(thirtyf_sl_mod, thirtyf)
```

```{r}
m4 <- ggplot(thirtyf_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = thirtyf_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co4 <- ggplot(thirtyf_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = thirtyf_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq4 <- ggplot(thirtyf_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr4 <- ggplot(thirtyf_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```



## subjects data plots


```{r}
two_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = two)
```


### Data plots 

```{r}
two_sl_fitted <- sl_extract_fitted(two_sl_mod, two)
two_sl_lcr <- sl_extract_lcr(two_sl_mod, two)
```

```{r}
m5 <- ggplot(two_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = two_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co5 <- ggplot(two_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = two_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq5 <- ggplot(two_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr5 <- ggplot(two_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

##four data plot 

```{r}
four_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = four)
```


### Data plots 

```{r}
four_sl_fitted <- sl_extract_fitted(four_sl_mod, four)
four_sl_lcr <- sl_extract_lcr(four_sl_mod, four)
```

```{r}
m6 <- ggplot(four_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data =four_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co6 <- ggplot(four_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = four_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq6 <- ggplot(four_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr6 <- ggplot(four_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

##six data plot 
```{r}
six_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = six)
six_sl_sim <- sl_sim(six_sl_mod, six, seed = 2345)
six_sl_fitted <- sl_extract_fitted(six_sl_mod, six)
six_sl_lcr <- sl_extract_lcr(six_sl_mod, six)
```


```{r}
m7 <- ggplot(six_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = six_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co7 <- ggplot(six_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = six_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq7 <- ggplot(six_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

lcr7 <- ggplot(six_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

```{r}
# mean value changed

m0+m1 + ggtitle("20% noise")+
m2 + ggtitle("25% noise")+
m3 + ggtitle("30% noise")+
m4 + ggtitle("35% noise")

co0+co1 + ggtitle("20% noise")+
co2 + ggtitle("25% noise")+
co3 + ggtitle("30% noise")+
co4 + ggtitle("35% noise")
cq0+cq1 + ggtitle("20% noise")+
cq2 + ggtitle("25% noise")+
cq3 + ggtitle("30% noise")+
cq4 + ggtitle("35% noise")
lcr0+lcr1 + ggtitle("20% noise")+
lcr2 + ggtitle("25% noise")+
lcr3 + ggtitle("30% noise")+
lcr4 + ggtitle("35% noise")

```
```{r}
# mean value changed

m0+m01 + ggtitle("5% noise")+
m2 + ggtitle("10% noise")+
m3 + ggtitle("15% noise")+
m1 + ggtitle("20% noise")+
m2 + ggtitle("25% noise")+
m3 + ggtitle("30% noise")+
m4 + ggtitle("35% noise")+
m5 + ggtitle("2 subs")+
m6 + ggtitle("4 subs")+
m7 + ggtitle("6 subs")


co0+co01 + ggtitle("5% noise")+
co02 + ggtitle("10% noise")+
co03 + ggtitle("15% noise")+
co1 + ggtitle("20% noise")+
co2 + ggtitle("25% noise")+
co3 + ggtitle("30% noise")+
co4 + ggtitle("35% noise")+
co5 + ggtitle("2 subs")+
co6 + ggtitle("4 subs")+
co7 + ggtitle("6 subs")

cq0+cq01 + ggtitle("5% noise")+
cq02 + ggtitle("10% noise")+
cq03 + ggtitle("15% noise")+
cq1 + ggtitle("20% noise")+
cq2 + ggtitle("25% noise")+
cq3 + ggtitle("30% noise")+
cq4 + ggtitle("35% noise")+
cq5 + ggtitle("2 subs")+
cq6 + ggtitle("4 subs")+
cq7 + ggtitle("6 subs")

lcr0+lcr01 + ggtitle("5% noise")+
lcr02 + ggtitle("10% noise")+
lcr03 + ggtitle("15% noise")+
lcr1 + ggtitle("20% noise")+
lcr2 + ggtitle("25% noise")+
lcr3 + ggtitle("30% noise")+
lcr4 + ggtitle("35% noise")+
lcr5 + ggtitle("2 subs")+
lcr6 + ggtitle("4 subs")+
lcr7 + ggtitle("6 subs")


```

```{r}
# subjects 

m0+m5 + ggtitle("2 subs")+
m6 + ggtitle("4 subs")+
m7 + ggtitle("6 subs")

co0+co5 + ggtitle("2 subs")+
co6 + ggtitle("4 subs")+
co7 + ggtitle("6 subs")

cq0+cq5 + ggtitle("2 subs")+
cq6 + ggtitle("4 subs")+
cq7 + ggtitle("6 subs")

lcr0+lcr5 + ggtitle("2 subs")+
lcr6 + ggtitle("4 subs")+
lcr7 + ggtitle("6 subs")


```


### Simulation for 5%


```{r}
five_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = five)
five_sl_sim <- sl_sim(five_sl_mod, six, seed = 2345)
five_sl_fitted <- sl_extract_fitted(five_sl_mod, five)
five_sl_lcr <- sl_extract_lcr(five_sl_mod, five)
five_sl_sim_fitted <- std_res(five_sl_sim)
five_sl_simlcr <- lcr_res(five_sl_sim)

```
#### Lineup plots

```{r five3n-plo2, fig.height=6}
five_1 <-
  lineup(true = five_sl_fitted,
         samples = five_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r five3n-plo4, fig.height=6}
five_2 <-
  lineup(true = five_sl_fitted,
         samples = five_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r five3n-plo6, fig.height=6}
five_3 <-
  lineup(true = five_sl_fitted,
         samples = five_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

```


```{r five3n-plo6-lcr, fig.height=6}
five_4 <-
  lineup(true = five_sl_lcr,
         samples = five_sl_simlcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

five_1
five_2
five_3
five_4

```

### Simulation for 10%


```{r}
ten_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = ten)
ten_sl_sim <- sl_sim(ten_sl_mod, six, seed = 2345)
ten_sl_fitted <- sl_extract_fitted(ten_sl_mod, ten)
ten_sl_lcr <- sl_extract_lcr(ten_sl_mod, ten)
ten_sl_sim_fitted <- std_res(ten_sl_sim)
ten_sl_simlcr <- lcr_res(ten_sl_sim)

```
#### Lineup plots

```{r ten3n-plo2, fig.height=6}
ten_1 <-
  lineup(true = ten_sl_fitted,
         samples = ten_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r ten3n-plo4, fig.height=6}
ten_2 <-
  lineup(true = ten_sl_fitted,
         samples = ten_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r ten3n-plo6, fig.height=6}
ten_3 <-
  lineup(true = ten_sl_fitted,
         samples = ten_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

```


```{r ten3n-plo6-lcr, fig.height=6}
ten_4 <-
  lineup(true = ten_sl_lcr,
         samples = ten_sl_simlcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ten_1
ten_2
ten_3
ten_4

```

### Simulation for 15%


```{r}
ften_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = ften)
ften_sl_sim <- sl_sim(ften_sl_mod, six, seed = 2345)
ften_sl_fitted <- sl_extract_fitted(ften_sl_mod, ften)
ften_sl_lcr <- sl_extract_lcr(ften_sl_mod, ften)
ften_sl_sim_fitted <- std_res(ften_sl_sim)
ften_sl_simlcr <- lcr_res(ften_sl_sim)

```
#### Lineup plots

```{r ften3n-plo2, fig.height=6}
ften_1 <-
  lineup(true = ften_sl_fitted,
         samples = ften_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r ften3n-plo4, fig.height=6}
ften_2 <-
  lineup(true = ften_sl_fitted,
         samples = ften_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r ften3n-plo6, fig.height=6}
ften_3 <-
  lineup(true = ften_sl_fitted,
         samples = ften_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

```


```{r ften3n-plo6-lcr, fig.height=6}
ften_4 <-
  lineup(true = ften_sl_lcr,
         samples = ften_sl_simlcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

ften_1
ften_2
ften_3
ften_4

```




## 6 subjects


```{r nullfitted-six2}
six_sl_sim_fitted <- std_res(six_sl_sim)
```

```{r lcrsimnull-six2}
six_sl_simlcr <- lcr_res(six_sl_sim)

```

```{r}
t_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = thirtyf)
t_sl_sim <- sl_sim(t_sl_mod, six, seed = 2345)
t_sl_fitted <- sl_extract_fitted(t_sl_mod, thirtyf)
t_sl_lcr <- sl_extract_lcr(t_sl_mod, thirtyf)
```

```{r nullfitted-six2}
t_sl_sim_fitted <- std_res(t_sl_sim)
```

```{r lcrsimnull-six2}
t_sl_simlcr <- lcr_res(t_sl_sim)

```


#### Lineup plots

```{r six3n-plo2, fig.height=6}
six_1 <-
  lineup(true = six_sl_fitted,
         samples = six_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r six3n-plo4, fig.height=6}
six_2 <-
  lineup(true = six_sl_fitted,
         samples = six_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r six3n-plo6, fig.height=6}
six_3 <-
  lineup(true = six_sl_fitted,
         samples = six_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

```


```{r six3n-plo6-lcr, fig.height=6}
six_4 <-
  lineup(true = six_sl_lcr,
         samples = six_sl_simlcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )


```

### line ups for 35% 


```{r tn-plo2, fig.height=6}
t_1 <-
  lineup(true = t_sl_fitted,
         samples = t_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r tn-plo4, fig.height=6}
t_2 <-
  lineup(true = t_sl_fitted,
         samples = t_sl_sim_fitted,
         pos = 13) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r tn-plo6, fig.height=6}
t_3 <-
  lineup(true = t_sl_fitted,
         samples = t_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )

```


```{r tn-plo6-lcr, fig.height=6}
t_4 <-
  lineup(true = t_sl_lcr,
         samples = t_sl_simlcr,
         pos = 4) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none",
    aspect.ratio = 1
  )



```
```{r}
six_1 + ggtitle("6 days")  +t_1 + ggtitle("35%")+five_1+ggtitle("5%")+twenty_1+ggtitle("20%")
six_2 + ggtitle("6 days")  +t_2+ ggtitle("35%")+five_2+ggtitle("5%")+twenty_2+ggtitle("20%")
six_3 +ggtitle("6 days")  +t_3+ ggtitle("35%")+five_3+ggtitle("5%")+twenty_3+ggtitle("20%")
six_4 +ggtitle("6 days")  + t_4+ ggtitle("35%")+five_4+ggtitle("5%")+twenty_4+ggtitle("20%")


five_1+ggtitle("5%")+twenty_1+ggtitle("20%")
five_2+ggtitle("5%")+twenty_2+ggtitle("20%")
five_3+ggtitle("5%")+twenty_3+ggtitle("20%")
five_4+ggtitle("5%")+twenty_4+ggtitle("20%")

```
5 % is not too obvious and true plot can be made out

