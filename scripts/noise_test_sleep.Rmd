---
title: "case5 noise test"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(mvtnorm)
library(dplyr)
library(tidyverse)
library(plyr)
library(nullabor)
library(MASS)
library(nlme)
library(plotrix)
library(patchwork)
```

18 subjects. 10 days. Day 0 normal sleep. Rest of nights 3 hours of sleep. Reaction variable records average reaction time (ms) per day. 

## Objectives of the residual diagnostics in this thesis 

> checking presence of outlying observations based on marginal residuals as well as conditional residuals, and 

> detecting normality of conditional error according to conditional residuals and confounded residuals.

```{r data}
# Data and its summary
data("sleepstudy")
summary(sleepstudy)
head(sleepstudy)
skimr::skim(sleepstudy)
```
## Actual plot

```{r}
sleepstudy %>%
  ggplot(aes(x=Days,y=Reaction,color=Subject))+
 # geom_point()+
  geom_smooth(method = "lm", se = FALSE)

ggplot(sleepstudy, aes(Days, Reaction)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)

ggplot(sleepstudy, aes(Subject, Reaction)) +
  geom_boxplot()

```


## checking if random effects need to be correlated or independent 

```{r random-intercept}

# random intercept and random slope
slmod1 <- lmer(Reaction ~ Days + (Days | Subject), data = sleepstudy)

# independent random effects
slmod2 <- lmer(Reaction ~ Days + (Days - 1 | Subject) +
  (1 | Subject), data = sleepstudy)
# summary(slmod1)
# summary(slmod2)

set.seed(987654321)
sl_mod2_sims <- simulate(slmod2, nsim = 19) # simulate the fitted linear mixed model
sl_mod2_refit <- lapply(sl_mod2_sims, refit, object = slmod2) # refits the model
sl_mod2_sim_ranef <- lapply(sl_mod2_refit, function(x) ranef(x)[[1]]) # extracts the modes of the random effects
sl_mod2_sim_ranef <- do.call("rbind", sl_mod2_sim_ranef) # binds the 19 different dataframes as one
sl_mod2_sim_ranef$.n <- rownames(sl_mod2_sim_ranef)

sl_mod2_sim_ranef$.n <- as.numeric(str_extract(sl_mod2_sim_ranef$.n, "\\d+")) # assigns numbers for each of 19 simulations
true_sl_mod1_ranef <- ranef(slmod1)$Subject # extracts modes of the correlated effects model

# places the true model among the simulated models to see if correlation between the random effets was necessary
sl_df <- nullabor:::add_true(sl_mod2_sim_ranef, true_sl_mod1_ranef, pos = 9)


ggplot(
  data = sl_df,
  aes(
    x = `(Intercept)`,
    y = Days
  )
) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, alpha = 0.4) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL)
```

The correlated model plot is not distinguishable from the independent random effects plot. There fore we could say that random effects could be independent. 

```{r}
set.seed(1234)


sample <- tibble(Subject=sample(sleepstudy$Subject,2))
test <- sleepstudy %>%
  dplyr::filter(Subject %in% sample$Subject)


test$y <- test$y + mean(sleepstudy$y) * 0.2

rest_test <- anti_join(sleepstudy,
  test,
  by = c(
    "Days",
    "Subject"
  )
)

dtest <- rbind(
  test,
  rest_test
)


summary(sleepstudy)
summary(dtest)

```
```{r}


ggplot(sleepstudy, aes(Days, y)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)

ggplot(dtest, aes(Days, y)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)

```


# number of days taken from each subject varied

```{r function}

sub_data<- function(sub){
set.seed(2000)


samp <- sleepstudy %>%
  group_by(Subject) %>%
  sample_n(size = sub) %>%
  tibble()

samp$y <- samp$y + mean(sleepstudy$y) * 0.2

rest3 <- anti_join(sleepstudy,
  samp,
  by = c(
    "Days",
    "Subject"
  )
)

n3 <- rbind(
  samp,
  rest3
)

return(n3)

}
```

```{r}
pointlm<- function(data){
  ggplot(data, aes(Days, y)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE) +
  ylim(150,600)
  
}


```

```{r}
zerobox <- ggplot(sleepstudy, aes(Subject, y)) +
  geom_boxplot()+
  ggtitle("zero noise")+
  ylim(150,600)

zeropoint <- ggplot(sleepstudy, aes(Days, y)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)+
  ggtitle("zero noise")+
  ylim(150,600)

box <- function(data){
  ggplot(data, aes(Subject, y)) +
  geom_boxplot()+
  ylim(150,600)
  }


```


```{r}
two <- sub_data(2)
four <- sub_data(4)
six <- sub_data(6)


```


```{r}

twopoint <- pointlm(two) +
  ggtitle("two subjects")

fourpoint <- pointlm(four)+
  ggtitle("4 subjects")
sixpoint <- pointlm(six)+
  ggtitle("6 subjects")

twobox <- box(two)+
  ggtitle("two subjects")
fourbox <- box(four)+
  ggtitle("4 subjects")
sixbox <- box(six)+
  ggtitle("6 subjects")

zeropoint+twopoint+fourpoint+sixpoint

zerobox+twobox+fourbox+sixbox

```



## changing noise strength

```{r function}

new_data<- function(noise){
set.seed(2000)


samp <- sleepstudy %>%
  group_by(Subject) %>%
  sample_n(size = 2) %>%
  tibble()

samp$y <- samp$y + mean(sleepstudy$y) * noise

rest3 <- anti_join(sleepstudy,
  samp,
  by = c(
    "Days",
    "Subject"
  )
)

n3 <- rbind(
  samp,
  rest3
)

return(n3)

}
```

```{r}
twenty <- new_data(0.2)
tfive <- new_data(0.25)
thirty <- new_data(0.3)
thirtyf<- new_data(0.35)



```


```{r}

twentypoint <- pointlm(twenty) +
  ggtitle("20%")
tfivepoint <- pointlm(tfive)+
  ggtitle("25%")
thirtypoint <- pointlm(thirty)+
  ggtitle("30%")
thirtyfpoint<- pointlm(thirtyf)+
  ggtitle("35%")

twentybox <- box(twenty) +
  ggtitle("20%")
tfivebox <- box(tfive)+
  ggtitle("25%")
thirtybox <- box(thirty)+
  ggtitle("30%")
thirtyfbox<- box(thirtyf)+
  ggtitle("35%")

zeropoint+twentypoint + tfivepoint + thirtypoint + thirtyfpoint 
zerobox+twentybox + tfivebox + thirtybox + thirtyfbox



```
```{r}
summary(sleepstudy)
summary(twenty)
summary(two)
```
```{r}
summary(sleepstudy)
summary(tfive)
summary(four)

```

Changing the strength of the mean value inserted to random 2 days of each subject is likely to give more outlying observations than increasing the number of days contaminated with 20% mean value for each subject. 


```{r}
summary(sleepstudy)
summary(thirty)
summary(six)

```
