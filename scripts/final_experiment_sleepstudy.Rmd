---
title: "experiment"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(mvtnorm)
library(dplyr)
library(tidyverse)
library(plyr)
library(nullabor)
library(MASS)
library(nlme)
library(plotrix)
library(patchwork)
```

18 subjects. 10 days. Day 0 normal sleep. Rest of nights 3 hours of sleep. Reaction variable records average reaction time (ms) per day. 

## Objectives of the residual diagnostics in this thesis 

> checking presence of outlying observations based on marginal residuals as well as conditional residuals, and 

> detecting normality of conditional error according to conditional residuals and confounded residuals.

```{r data}
# Data and its summary
data("sleepstudy")
summary(sleepstudy)
head(sleepstudy)
skimr::skim(sleepstudy)
```
## Actual plot

```{r}
sleepstudy %>%
  ggplot(aes(x=Days,y=Reaction,color=Subject))+
 #geom_point()+
  geom_smooth(method = "lm", se = FALSE)

ggplot(sleepstudy, aes(Days, Reaction)) +
  geom_point() +
  facet_wrap(~Subject) +
  geom_smooth(method = "lm", se = FALSE)

ggplot(sleepstudy, aes(Subject, Reaction)) +
  geom_boxplot()

```



## checking if random effects need to be correlated or independent 

```{r random-intercept}

# random intercept and random slope
slmod1 <- lmer(Reaction ~ Days + (Days | Subject), data = sleepstudy)

# independent random effects
slmod2 <- lmer(Reaction ~ Days + (Days - 1 | Subject) +
  (1 | Subject), data = sleepstudy)
# summary(slmod1)
# summary(slmod2)

set.seed(987654321)
sl_mod2_sims <- simulate(slmod2, nsim = 19) 
sl_mod2_refit <- lapply(sl_mod2_sims, refit, object = slmod2) # refits the model
sl_mod2_sim_ranef <- lapply(sl_mod2_refit, function(x) ranef(x)[[1]]) # extracts the modes of the random effects
sl_mod2_sim_ranef <- do.call("rbind", sl_mod2_sim_ranef) # binds the 19 different dataframes as one
sl_mod2_sim_ranef$.n <- rownames(sl_mod2_sim_ranef)

sl_mod2_sim_ranef$.n <- as.numeric(str_extract(sl_mod2_sim_ranef$.n, "\\d+")) # assigns numbers for each of 19 simulations
true_sl_mod1_ranef <- ranef(slmod1)$Subject # extracts modes of the correlated effects model

# places the true model among the simulated models to see if correlation between the random effets was necessary
sl_df <- nullabor:::add_true(sl_mod2_sim_ranef, true_sl_mod1_ranef, pos = 9)


ggplot(
  data = sl_df,
  aes(
    x = `(Intercept)`,
    y = Days
  )
) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, alpha = 0.4) +
  facet_wrap(~.sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL)
```

The correlated model plot is not distinguishable from the independent random effects plot. There fore we could say that random effects could be independent. 

```{r fitfn}
# returns a tibble with fitted values along with marginal , conditional residuals as well as std.marginal and conditional residuals
sl_extract_fitted <- function(mod, data) {
  
  N <- nrow(data)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()
  
 # subjects <- unique(data$Subject)
  #nsubjects <- length(subjects)

  #y <- data$y
  #X <- getME(mod, "X") # fixed effects model matrix
  #beta <- fixef(mod) # fixed effects estimate
  #Z <- getME(mod, "Z") # random effects matrix
  #u <- c(ranef(mod)$Subject[, 1], ranef(mod)$Subject[, 2]) # extracts the modes of the random effects
  #q <- length(u)
  
  y <- getME(mod, "y")
  X <- getME(mod, "X")
  beta <- getME(mod, "beta")
  Z <- getME(mod, "Z")
  u <- getME(mod, "b")
  q <- getME(mod, "q")
  
  nrfacs <- getME(mod,"n_rfacs")
  num <- 0

    if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(mod)))) 
 
 for(p in 1:nrfacs)
 {
  num[p] <- nrow(unique(a[p]))
 }
  vc <- as.data.frame(VarCorr(mod))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])# covariance matrix of random effects

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(mod))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}
  

  Sigma <- Z %*% G %*% t(Z) + R # covariance matrix of marginal distribution of observations

  Sigma_inv <- solve(Sigma) # inverse of sigma

  # variance of marginal residual = sigma-X(X^t * sigma^-1 * X)*X^t
  # variance of conditional residual = R*((sigma^-1)-(sigma^-1)*X*(X^t*sigma^-1*X)^-1*X^t*sigma^-1)*R



  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv # (sigma^-1)-(sigma^-1)*X*(X^t*sigma^-1*X)^-1*X^t*sigma^-1

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) # variance of marginal residual
  varCondRes <- R %*% P %*% R # variance of conditional residual
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G # random effects variance

  # fitted or estimated marginal mean = X*Beta

  fitted_df <- data %>%
    dplyr::mutate(
      fitted = as.vector(X %*% beta),
      resm = y - fitted,
      resc = as.vector(y - fitted - Z %*% u),
      index = 1:n()
    ) %>%
    mutate(
      resm_std = resm / sqrt(diag(varMargRes)[index]), # standardized marginal residual
      resc_std = resc / sqrt(diag(varCondRes)[index]) # standardized conditional residual
    ) %>%
    ungroup()

  return(fitted_df)
}
```

```{r lcrfn}

# returns the least confounded residual

sl_extract_lcr <- function(mod, data) {

  #n <- getME(mod, "n")
  N <- nrow(data)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()

 # y <- data$y
  #X <- getME(mod, "X")
  #beta <- fixef(mod)
  #Z <- getME(mod, "Z")
  #u <- c(ranef(mod)$Subject[, 1], ranef(mod)$Subject[, 2])
  #q <- length(u)
  
  
  y <- getME(mod, "y")
  X <- getME(mod, "X")
  beta <- getME(mod, "beta")
  Z <- getME(mod, "Z")
  u <- getME(mod, "b")
  q <- getME(mod, "q")
  
  nrfacs <- getME(mod,"n_rfacs")
  num <- 0

  if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(mod)))) 
 
 for(p in 1:nrfacs)
 {
  num[p] <- nrow(unique(a[p]))
 }
  vc <- as.data.frame(VarCorr(mod))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(mod)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(mod))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}
  Sigma <- Z %*% G %*% t(Z) + R

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- as.vector(y - fitted - Z %*% u)
  index <- 1:nrow(data)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])


  # standardized least confounded residual = c^T * e / sqrt(CRQRC^t)

  R_half <- expm::sqrtm(R)

  # singer et al calculation for least confounded residual
  auxqn <- eigen((R_half %*% P %*% R_half),
    symmetric = T,
    only.values = FALSE
  )

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N - p)])))) %*% t(auxqn$vectors[1:N, 1:(N - p)]) %*% solve(expm::sqrtm(R[1:N, 1:N]))

  var_resmcp <- lt %*% varCondRes[1:N, 1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N]) / sqrt(diag(var_resmcp))

  resmcp_sl <- tibble::tibble(resmcp)
  resmcp_sl <- resmcp_sl %>%
    mutate(index=1:nrow(resmcp_sl))

  return(resmcp_sl)
}
```

```{r simulate}
# simulation of the models
sl_sim <- function(mod, data, nsim = 19, seed, std = FALSE) {
  fit_sim <- simulate(mod, nsim = nsim, seed = seed)
  fit_refit <- lapply(fit_sim, refit, object = mod)
  fit_simy <- lapply(fit_refit, function(x) getME(x, "y"))
  fit_simy_y <- do.call("cbind", fit_simy)
  fit_simy_y <- reshape2::melt(fit_simy_y)[-1]
  names(fit_simy_y) <- c(".n", "y")
  fit_simy_y$.n <- as.numeric(str_extract(fit_simy_y$.n, "\\d+"))
  fit_simy_y$Subject <- rep(data$Subject, 19)
  fit_simy_y$Days <- rep(data$Days, 19)
  return(fit_simy_y)
}
```

```{r residual-extract}
colnames(sleepstudy)[1] <- c("y")
sl_fitted <- sl_extract_fitted(slmod2, sleepstudy)
sl_lcr <- sl_extract_lcr(slmod2, sleepstudy)
```


```{r null-stdres}

# function returns a tibble containing marginal, std marginal , conditonal and std. conditional residuals after 19 simulations
std_res <- function(data) {
  


purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = df)

  N <- nrow(df)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  y <- getME(m, "y")
  X <- getME(m, "X")
  beta <- getME(m, "beta")
  Z <- getME(m, "Z")
  u <- getME(m, "b")
  q <- getME(m, "q")

 nrfacs <- getME(m,"n_rfacs")
  num <- 0

  if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(m)))) 
 
 for(p in 1:nrfacs)
 {
  num[p] <- nrow(unique(a[p]))
 }
  vc <- as.data.frame(VarCorr(m))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(m))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}
  
  Sigma <- Z %*% G %*% t(Z) + R
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- y - fitted - as.vector(Z %*% u)
  index <- 1:nrow(df)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])

  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
}
```

```{r null-lcrres}
# function returns least conditional residual after 19 simulations
lcr_res <- function(data) {
  
  purrr::map_dfr(1:19, function(i) {
  df <- data %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = df)

  N <- nrow(df)
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  y <- getME(m, "y")
  X <- getME(m, "X")
  beta <- getME(m, "beta")
  Z <- getME(m, "Z")
  u <- getME(m, "b")
  q <- getME(m, "q")

 nrfacs <- getME(m,"n_rfacs")
 num <- 0 

  if(nrfacs>1)
    {
 a <-  data %>%
  select_if((names(data) %in% names(random.effects(m)))) 
 
 for(p in 1:nrfacs)
 {
  num[p] <- nrow(unique(a[p]))
 }
  vc <- as.data.frame(VarCorr(m))
  
   R <- vc$vcov[3] * diag(N) # covariance matrix of random errors
  G1 <- vc$vcov[1] * diag(num[2])
  G2 <- vc$vcov[2] * diag(num[1])

  G <- Matrix::bdiag(G1, G2)
    } else   
  {
  num <- data %>%
  select_if((names(data) %in% names(random.effects(m)))) %>%
  unique() %>%
  nrow()

  vc <- as.data.frame(VarCorr(m))
   R <-  vc$vcov[3] * diag(N)
  G1 <- vc$vcov[1] * diag(num)
  G2 <- vc$vcov[2] * diag(num)
  G <- Matrix::bdiag(G1, G2)
}

  Sigma <- Z %*% G %*% t(Z) + R
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X)
  varCondRes <- R %*% P %*% R
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted <- as.vector(X %*% beta)
  resm <- y - fitted
  resc <- y - fitted - as.vector(Z %*% u)
  index <- 1:nrow(df)
  resm_std <- resm / sqrt(diag(varMargRes)[index])
  resc_std <- resc / sqrt(diag(varCondRes)[index])

  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half),
    symmetric = T,
    only.values = FALSE
  )

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N - p)])))) %*% t(auxqn$vectors[1:N, 1:(N - p)]) %*% solve(expm::sqrtm(R[1:N, 1:N]))

  var_resmcp <- lt %*% varCondRes[1:N, 1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N]) / sqrt(diag(var_resmcp))
  .n <- i

  resmcp_tibble <- tibble::tibble(.n, resmcp)
  
  resmcp_tibble <- resmcp_tibble %>%
    mutate(index=1:nrow(resmcp_tibble))

  return(resmcp_tibble)
  
})
  
}
```


 

## no noise


```{r v1mod}
v1_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = sleepstudy)
```


### Data plots from no noise model

```{r v1data}
v1_sl_fitted <- sl_extract_fitted(v1_sl_mod, sleepstudy)
v1_sl_lcr <- sl_extract_lcr(v1_sl_mod, sleepstudy)
```

```{r}
ggplot(v1_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v1_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
 ggplot(v1_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v1_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

ggplot(v1_sl_fitted, aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red")

ggplot(v1_sl_lcr, aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red")
```

# 1st replication 

```{r}
v11_sl_sim <- sl_sim(v1_sl_mod, sleepstudy, seed = 1238)
v11_sl_sim_fitted <- std_res(v11_sl_sim)
v11_sl_simlcr <- lcr_res(v11_sl_sim)
```


#### Lineup plots



```{r v113n-plo4, fig.height=6}
v11_1 <-
  lineup(true = v1_sl_fitted,
         samples = v11_sl_sim_fitted,
         pos = 3) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )



```

```{r v113n-plo6, fig.height=6}
v11_2 <-
  lineup(true = v1_sl_fitted,
         samples = v11_sl_sim_fitted,
         pos = 1) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v113n-plo6-lcr, fig.height=6}
v11_3 <-
  lineup(true = v1_sl_lcr,
         samples = v11_sl_simlcr,
         pos = 7) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

v11_4 <-
  lineup(true = v1_sl_lcr,
         samples = v11_sl_simlcr,
         pos = 5) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )



ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v11_1.png",
  plot = v11_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v11_2.png",
  plot = v11_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v11_3.png",
  plot = v11_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v11_4.png",
  plot = v11_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v11_1
v11_2
v11_3
v11_4
```

# 2nd replication 

```{r}
v12_sl_sim <- sl_sim(v1_sl_mod, sleepstudy, seed = 2468)
v12_sl_sim_fitted <- std_res(v12_sl_sim)
v12_sl_simlcr <- lcr_res(v12_sl_sim)
```


#### Lineup plots



```{r v123n-plo4, fig.height=6}
v12_1 <-
  lineup(true = v1_sl_fitted,
         samples = v12_sl_sim_fitted,
         pos = 5) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v123n-plo6, fig.height=6}
v12_2 <-
  lineup(true = v1_sl_fitted,
         samples = v12_sl_sim_fitted,
         pos = 2) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v123n-plo6-lcr, fig.height=6}
v12_3 <-
  lineup(true = v1_sl_lcr,
         samples = v12_sl_simlcr,
         pos = 8) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


v12_4 <-
  lineup(true = v1_sl_lcr,
         samples = v12_sl_simlcr,
         pos = 1) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v12_1.png",
  plot = v12_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v12_2.png",
  plot = v12_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v12_3.png",
  plot = v12_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v12_4.png",
  plot = v12_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v12_1
v12_2
v12_3
v12_4
```

# 3rd replication 

```{r}
v13_sl_sim <- sl_sim(v1_sl_mod, sleepstudy, seed = 4215)
v13_sl_sim_fitted <- std_res(v13_sl_sim)
v13_sl_simlcr <- lcr_res(v13_sl_sim)
```


#### Lineup plots



```{r v133n-plo4, fig.height=6}
v13_1 <-
  lineup(true = v1_sl_fitted,
         samples = v13_sl_sim_fitted,
         pos = 2) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v133n-plo6, fig.height=6}
v13_2 <-
  lineup(true = v1_sl_fitted,
         samples = v13_sl_sim_fitted,
         pos = 5) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v133n-plo6-lcr, fig.height=6}
v13_3 <-
  lineup(true = v1_sl_lcr,
         samples = v13_sl_simlcr,
         pos = 9) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

v13_4 <-
  lineup(true = v1_sl_lcr,
         samples = v13_sl_simlcr,
         pos = 6) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v13_4.png",
  plot = v13_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)


ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v13_1.png",
  plot = v13_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v13_2.png",
  plot = v13_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v13_3.png",
  plot = v13_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v13_1
v13_2
v13_3
v13_4
```

# 4th replication 

```{r}
v14_sl_sim <- sl_sim(v1_sl_mod, sleepstudy, seed = 3941)
v14_sl_sim_fitted <- std_res(v14_sl_sim)
v14_sl_simlcr <- lcr_res(v14_sl_sim)
```


#### Lineup plots



```{r v143n-plo4, fig.height=6}
v14_1 <-
  lineup(true = v1_sl_fitted,
         samples = v14_sl_sim_fitted,
         pos = 10) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v143n-plo6, fig.height=6}
v14_2 <-
  lineup(true = v1_sl_fitted,
         samples = v14_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v143n-plo6-lcr, fig.height=6}
v14_3 <-
  lineup(true = v1_sl_lcr,
         samples = v14_sl_simlcr,
         pos = 9) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

v14_4 <-
  lineup(true = v1_sl_lcr,
         samples = v14_sl_simlcr,
         pos = 10) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v14_4.png",
  plot = v14_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v14_1.png",
  plot = v14_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v14_2.png",
  plot = v14_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v14_3.png",
  plot = v14_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v14_1
v14_2
v14_3
v14_4
```


# 5th replication 

```{r}
v15_sl_sim <- sl_sim(v1_sl_mod, sleepstudy, seed = 6623)
v15_sl_sim_fitted <- std_res(v15_sl_sim)
v15_sl_simlcr <- lcr_res(v15_sl_sim)
```


#### Lineup plots



```{r v153n-plo4, fig.height=6}
v15_1 <-
  lineup(true = v1_sl_fitted,
         samples = v15_sl_sim_fitted,
         pos = 7) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v153n-plo6, fig.height=6}
v15_2 <-
  lineup(true = v1_sl_fitted,
         samples = v15_sl_sim_fitted,
         pos = 3) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v153n-plo6-lcr, fig.height=6}
v15_3 <-
  lineup(true = v1_sl_lcr,
         samples = v15_sl_simlcr,
         pos = 10) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

v15_4 <-
  lineup(true = v1_sl_lcr,
         samples = v15_sl_simlcr,
         pos = 13) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v15_4.png",
  plot = v15_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v15_1.png",
  plot = v15_1,
  device = "png",
  dpi = 300,
  height = 12, 
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v15_2.png",
  plot = v15_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v15_3.png",
  plot = v15_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v15_1
v15_2
v15_3
v15_4
```



## adding noise

```{r function}

new_data<- function(noise){
set.seed(2000)


subs <- sleepstudy %>%
  distinct(Subject)%>%
  sample_n(size=6)
  
  
samp <- sleepstudy %>%
  filter(Subject %in% subs$Subject)%>%
  group_by(Subject)%>%
  sample_n(size = 2) %>%
  tibble()


samp$y <- samp$y + mean(sleepstudy$y) * noise

rest3 <- anti_join(sleepstudy,
  samp,
  by = c(
    "Days",
    "Subject"
  )
)

n3 <- rbind(
  samp,
  rest3
)

return(n3)

}
```

# reference plot 


```{r}
ref <- new_data(0.4)
```

```{r}
vref_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = ref)
vref_sl_fitted <- sl_extract_fitted(vref_sl_mod, ref)
vref_sl_lcr <- sl_extract_lcr(vref_sl_mod, ref)
```

# 1st replication 

```{r}
vref1_sl_sim <- sl_sim(vref_sl_mod, ref, seed = 2345)
vref1_sl_sim_fitted <- std_res(vref1_sl_sim)
vref1_sl_simlcr <- lcr_res(vref1_sl_sim)
```


#### Lineup plots



```{r vref13n-plo4, fig.height=6}
vref1_1 <-
  lineup(true = vref_sl_fitted,
         samples = vref1_sl_sim_fitted,
         pos = 8) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "vNA1_NA.png",
  plot = vref1_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "vNA2_NA.png",
  plot = vref1_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "vNA3_NA.png",
  plot = vref1_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "vNA4_NA.png",
  plot = vref1_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)
ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "vNA5_NA.png",
  plot = vref1_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



```




```{r}
twenty <- new_data(0.2)

```

# 20 %


```{r}
v21_sl_mod <- lmer(y ~ Days + (Days - 1 | Subject) + (1 | Subject), data = twenty)
v21_sl_fitted <- sl_extract_fitted(v21_sl_mod, twenty)
v21_sl_lcr <- sl_extract_lcr(v21_sl_mod, twenty)
```


```{r}
m1 <- ggplot(v21_sl_fitted, aes(index, resm_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v21_sl_fitted %>% filter(resm_std > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )
co1 <- ggplot(v21_sl_fitted, aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_text(
    data = v21_sl_fitted %>% filter(abs(resc_std) > 3),
    aes(label = index),
    nudge_x = 0.35,
    nudge_y = 0.35,
    size = 2
  )

cq1 <- ggplot(v21_sl_fitted, aes(index,resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) 
v21_sl_lcr <- v21_sl_lcr %>%
  mutate(n=1:nrow(v21_sl_lcr))

lcr1 <- ggplot(v21_sl_lcr, aes(n,resmcp)) +
  geom_point()+
  geom_hline(yintercept = 0) 
m1
co1 
cq1
lcr1
```

# 1st replication 

```{r}
v21_sl_sim <- sl_sim(v21_sl_mod, twenty, seed = 2345)
v21_sl_sim_fitted <- std_res(v21_sl_sim)
v21_sl_simlcr <- lcr_res(v21_sl_sim)
```


#### Lineup plots



```{r v213n-plo4, fig.height=6}
v21_1 <-
  lineup(true = v21_sl_fitted,
         samples = v21_sl_sim_fitted,
         pos = 1) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v213n-plo6, fig.height=6}
v21_2 <-
  lineup(true = v21_sl_fitted,
         samples = v21_sl_sim_fitted,
         pos = 4) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v213n-plo6-lcr, fig.height=6}
v21_3 <-
  lineup(true = v21_sl_lcr,
         samples = v21_sl_simlcr,
         pos = 14) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

v21_4 <-
  lineup(true = v1_sl_lcr,
         samples = v21_sl_simlcr,
         pos = 6) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v21_4.png",
  plot = v21_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v21_1.png",
  plot = v21_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v21_2.png",
  plot = v21_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v21_3.png",
  plot = v21_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v21_1
v21_2
v21_3
v21_4
```

# 2nd replication 

```{r}
v22_sl_sim <- sl_sim(v21_sl_mod, twenty, seed = 5974)
v22_sl_sim_fitted <- std_res(v22_sl_sim)
v22_sl_simlcr <- lcr_res(v22_sl_sim)
```


#### Lineup plots



```{r v223n-plo4, fig.height=6}
v22_1 <-
  lineup(true = v21_sl_fitted,
         samples = v22_sl_sim_fitted,
         pos = 6) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v223n-plo6, fig.height=6}
v22_2 <-
  lineup(true = v21_sl_fitted,
         samples = v22_sl_sim_fitted,
         pos = 14) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v223n-plo6-lcr, fig.height=6}
v22_3 <-
  lineup(true = v21_sl_lcr,
         samples = v22_sl_simlcr,
         pos = 3) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

v22_4 <-
  lineup(true = v1_sl_lcr,
         samples = v22_sl_simlcr,
         pos = 11) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v22_4.png",
  plot = v22_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v22_1.png",
  plot = v22_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v22_2.png",
  plot = v22_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v22_3.png",
  plot = v22_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v22_1
v22_2
v22_3
v22_4
```

# 3rd replication 

```{r}
v23_sl_sim <- sl_sim(v21_sl_mod, twenty, seed = 7561)
v23_sl_sim_fitted <- std_res(v23_sl_sim)
v23_sl_simlcr <- lcr_res(v23_sl_sim)
```


#### Lineup plots



```{r v233n-plo4, fig.height=6}
v23_1 <-
  lineup(true = v21_sl_fitted,
         samples = v23_sl_sim_fitted,
         pos = 3) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v233n-plo6, fig.height=6}
v23_2 <-
  lineup(true = v21_sl_fitted,
         samples = v23_sl_sim_fitted,
         pos = 7) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v233n-plo6-lcr, fig.height=6}
v23_3 <-
  lineup(true = v21_sl_lcr,
         samples = v23_sl_simlcr,
         pos = 5) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

v23_4 <-
  lineup(true = v1_sl_lcr,
         samples = v23_sl_simlcr,
         pos = 12) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v23_4.png",
  plot = v23_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v23_1.png",
  plot = v23_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v23_2.png",
  plot = v23_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v23_3.png",
  plot = v23_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v23_1
v23_2
v23_3
v23_4
```


# 4th replication 

```{r}
v24_sl_sim <- sl_sim(v21_sl_mod, twenty, seed = 1531)
v24_sl_sim_fitted <- std_res(v24_sl_sim)
v24_sl_simlcr <- lcr_res(v24_sl_sim)
```


#### Lineup plots



```{r v243n-plo4, fig.height=6}
v24_1 <-
  lineup(true = v21_sl_fitted,
         samples = v24_sl_sim_fitted,
         pos = 6) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v243n-plo6, fig.height=6}
v24_2 <-
  lineup(true = v21_sl_fitted,
         samples = v24_sl_sim_fitted,
         pos = 14) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v243n-plo6-lcr, fig.height=6}
v24_3 <-
  lineup(true = v21_sl_lcr,
         samples = v24_sl_simlcr,
         pos = 3) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )
v24_4 <-
  lineup(true = v1_sl_lcr,
         samples = v24_sl_simlcr,
         pos = 16) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v24_4.png",
  plot = v24_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v24_1.png",
  plot = v24_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v24_2.png",
  plot = v24_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v24_3.png",
  plot = v24_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v24_1
v24_2
v24_3
v24_4
```


# 5th replication 

```{r}
v25_sl_sim <- sl_sim(v21_sl_mod, twenty, seed = 4371)
v25_sl_sim_fitted <- std_res(v25_sl_sim)
v25_sl_simlcr <- lcr_res(v25_sl_sim)
```


#### Lineup plots



```{r v253n-plo4, fig.height=6}
v25_1 <-
  lineup(true = v21_sl_fitted,
         samples = v25_sl_sim_fitted,
         pos = 6) %>%
  ggplot(aes(index, resc_std)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )


```

```{r v253n-plo6, fig.height=6}
v25_2 <-
  lineup(true = v21_sl_fitted,
         samples = v25_sl_sim_fitted,
         pos = 14) %>%
  ggplot(aes(sample = resc_std)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

```


```{r v253n-plo6-lcr, fig.height=6}
v25_3 <-
  lineup(true = v21_sl_lcr,
         samples = v25_sl_simlcr,
         pos = 3) %>%
  ggplot(aes(sample = resmcp)) +
  geom_qq() +
  geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

v25_4 <-
  lineup(true = v1_sl_lcr,
         samples = v25_sl_simlcr,
         pos = 13) %>%
  ggplot(aes(index, resmcp)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol = 5) +
  xlab(NULL) +
  ylab(NULL) +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "none"
  )

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v25_4.png",
  plot = v25_4,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v25_1.png",
  plot = v25_1,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v25_2.png",
  plot = v25_2,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)

ggsave(
  path = here::here("experiment/www/images/sleepstudy/"),
  filename = "v25_3.png",
  plot = v25_3,
  device = "png",
  dpi = 300,
  height = 12,
  width = 12
)



v25_1
v25_2
v25_3
v25_4
```


